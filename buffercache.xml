<sect1 id="buffercache">
 <title>pg_buffercache</title>
 
 <indexterm zone="buffercache">
  <primary>pg_buffercache</primary>
 </indexterm>

 <para>
  Le module <literal>pg_buffercache</literal> permet d'examiner ce qui
  arrive dans les caches à tout moment sans avoir à redémarrer ou à
  reconstruire le serveur avec du code de déboguage. buffercache doit être
  au cache ce que pg_locks est aux verrous.
 </para>
 <para>
  Ce module consiste en une fonction C <literal>pg_buffercache_pages()</literal>
  qui renvoie un ensemble d'enregistrements. Il comprend aussi une vue
  nommée <literal>pg_buffercache</literal> qui ne fait qu'appeler la fonction.
 </para>
 <para>
  Par défaut, l'accès public à cette fonction est interdite pour des raisons
  de sécurité.
 </para>

 <sect2>
  <title>Notes</title>
  <para>
   Voici la définition des colonnes exposées dans la vue&nbsp;:
  </para>
  <programlisting>
       Colonn     |  Références          | Description
  ----------------+----------------------+------------------------------------
   bufferid       |                      | Id, de 1 à shared_buffers.
   relfilenode    | pg_class.relfilenode | Refilenode de la relation.
   reltablespace  | pg_tablespace.oid    | OID du tablespace de la relation.
   reldatabase    | pg_database.oid      | Base de la relation.
   relblocknumber |                      | Décalage de la page dans la relation.
   isdirty        |                      | Page modifiée ?
   usagecount     |                      | Numéro LRU de la page.
  </programlisting>
  <para>
   Il existe une ligne par cache dans le tampon. Les tampons inutilisés sont
   montrés mais tous les champs sont NULL sauf bufferid.
  </para>
  <para>
   Comme le cache est partagé par toutes les bases, il s'y trouve des pages
   concernant des relations n'appartenant à la base en cours (ie où vous
   êtes connectés).
  </para>
  <para>
   Quand la vue pg_buffercache est utilisé, les verrous du gestion de tampons
   interne sont utilisés, et une copie des données du cache est réalisée pour
   son affichage par la vue. Ceci permet de s'assurer que la vue produit un
   ensemble cohérent de résultats, tout en ne bloquant pas l'activité des
   caches plus longtemps que nécessaire. Néanmoins, cela peut avoir un impact
   sur les performances de la base de données si cette vue est lue fréquemment.
  </para>
 </sect2>

 <sect2>
  <title>Exemple</title>
  <programlisting>
  regression=# \d pg_buffercache;
       View "public.pg_buffercache"
       Column     |  Type    | Modifiers
  ----------------+----------+-----------
   bufferid       | integer  |
   relfilenode    | oid      |
   reltablespace  | oid      |
   reldatabase    | oid      |
   relblocknumber | bigint   |
   isdirty        | boolean  |
   usagecount     | smallint |

  View definition:
   SELECT p.bufferid, p.relfilenode, p.reltablespace, p.reldatabase, 
          p.relblocknumber, p.isdirty, p.usagecount
     FROM pg_buffercache_pages() p(bufferid integer, relfilenode oid, 
     reltablespace oid, reldatabase oid, relblocknumber bigint, 
     isdirty boolean, usagecount smallint);

  regression=# SELECT c.relname, count(*) AS buffers
               FROM pg_class c INNER JOIN pg_buffercache b
               ON b.relfilenode = c.relfilenode INNER JOIN pg_database d
               ON (b.reldatabase = d.oid AND d.datname = current_database())
               GROUP BY c.relname
               ORDER BY 2 DESC LIMIT 10;
               relname             | buffers
  ---------------------------------+---------
   tenk2                           |     345
   tenk1                           |     141
   pg_proc                         |      46
   pg_class                        |      45
   pg_attribute                    |      43
   pg_class_relname_nsp_index      |      30
   pg_proc_proname_args_nsp_index  |      28
   pg_attribute_relid_attnam_index |      26
   pg_depend                       |      22
   pg_depend_reference_index       |      20
  (10 rows)

  regression=# 
  </programlisting>
 </sect2>

 <sect2>
  <title>Auteurs</title>
  <itemizedlist>
   <listitem>
    <para>
     Mark Kirkwood <email>markir@paradise.net.nz</email>
    </para>
   </listitem>
   <listitem>
    <para>Suggestions pour la conception&nbsp;: Neil Conway
    <email>neilc@samurai.com</email></para>
   </listitem>
   <listitem>
    <para>Conseil pour le débogage&nbsp;: Tom Lane <email>tgl@sss.pgh.pa.us</email></para>
   </listitem>
  </itemizedlist>
 </sect2>

</sect1>

