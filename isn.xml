<sect1 id="isn">
 <title>isn</title>
 
 <indexterm zone="isn">
  <primary>isn</primary>
 </indexterm>

 <para>
  Le module <literal>isn</literal> ajoute des types de données pour les
  espaces de noms suivants du standard international&nbsp;: EAN13, UPC,
  ISBN (pour les livres), ISMN (pour la musique) et ISSN (pour les numéros
  de série). Ce module est inspiré du code isbn_issn de Garrett A. Wollman.
 </para>
 <para>
  Ce module valide et ajoute automatiquement les tirets corrects pour les
  nombres. De plus, il support les nouveaux nombres ISBN-13 à utiliser
  depuis janvier 2007.
 </para>

 <para>
  Pour commencer&nbsp;:
 </para>

 <orderedlist>
  <listitem>
   <para>Les nombres ISBN13, ISMN13, ISSN13 sont tous des nombres EAN13</para>
  </listitem>
  <listitem>
   <para>Les nombres EAN13 ne sont pas toujours ISBN13, ISMN13 ou ISSN13 (mais
    certains le sont)</para>
  </listitem>
  <listitem>
   <para>Certains nombres ISBN13 peuvent être affichés en tant qu'ISBN</para>
  </listitem>
  <listitem>
   <para>Certains nombres ISMN13 peuvent être affichés en tant qu'ISMN</para>
  </listitem>
  <listitem>
   <para>Certains nombres ISSN13 peuvent être affichés en tant qu'ISSN</para>
  </listitem>
  <listitem>
   <para>Tous les nombres UPC, ISBN, ISMN et ISSN peuvent être représentés
    sous la forme de nombres EAN13</para>
  </listitem>
 </orderedlist>

 <note>
  <para>
   Tous les types sont représentés en interne sous la forme d'entiers de 64
   bits, et sont interchangeables.
  </para>
 </note>
 <note>
  <para>
   Nous avons deux classes d'opérateur (pour les btree et pour les hash),
   donc chaque type de données peut être indexé pour un accès rapide.
  </para>
 </note>

 <sect2>
  <title>Types de données</title>
  
  <para>
   Nous avons les types de données suivants&nbsp;:
  </para>

  <table>
   <title>Types de données</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry><para>Type de données</para></entry>
      <entry><para>Description</para></entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry><para><literal>EAN13</literal></para></entry>
      <entry>
       <para>
        Numéros européens d'article (<foreignphrase>European Article
	Numbers</foreignphrase>. Ce type affichera toujours le format EAN13.
	La fonction d'affichage est <literal>ean13_out()</literal>
       </para>
      </entry>
     </row>

     <row>
      <entry><para><literal>ISBN13</literal></para></entry>
      <entry>
       <para>
        Standard international pour les numéros de livre
	(<foreignphrase>International Standard Book Numbers</foreignphrase>)
	à afficher dans le nouveau format EAN13.
       </para>
      </entry>
     </row>

     <row>
      <entry><para><literal>ISMN13</literal></para></entry>
      <entry>
       <para>
        Standard international des numéros de musique
	(<foreignphrase>International Standard Music Numbers</foreignphrase>
	à afficher dans le nouveau format EAN13.
       </para>
      </entry>
     </row>
     <row>
      <entry><para><literal>ISSN13</literal></para></entry>
      <entry>
       <para>
        Standard international des numéros de série
	(<foreignphrase>International Standard Serial Numbers</foreignphrase>)
	à afficher dans le nouveau format EAN13.
       </para>
      </entry>
     </row>
     <row>
      <entry><para><literal>ISBN</literal></para></entry>
      <entry>
       <para>
        Standard internal pour les numéros de livres
	(<foreignphrase>International Standard Book Numbers</foreignphrase>)
	à afficher dans le format court.
       </para>
      </entry>
     </row>
     <row>
      <entry><para><literal>ISMN</literal></para></entry>
      <entry>
       <para>
        Standard international des numéros de musique
	(<foreignphrase>International Standard Music Numbers</foreignphrase>
	à afficher dans le format court.
       </para>
      </entry>
     </row>
     <row>
      <entry><para><literal>ISSN</literal></para></entry>
      <entry>
       <para>
        Standard international des numéros de série
	(<foreignphrase>International Standard Serial Numbers</foreignphrase>)
	à afficher dans le format court. Ces types affichent la version
	courte d'ISxN (ISxN 10) à chaque fois que c'est possible, et
	affichera la version ISxN 13 dans le cas contraire. La fonction
        d'affichage est <literal>isn_out()</literal>
       </para>
      </entry>
     </row>
     <row>
      <entry><para><literal>UPC</literal></para></entry>
      <entry>
       <para>
        Codes de produit universels (<foreignphrase>Universal Product
	Codes</foreignphrase>). Les codes UPC sont un sous-ensemble des codes
	EAN13 (ils sont basiquement EAN13 sans le premier chiffre 0). La
        fonction d'affichage est aussi <literal>isn_out()</literal>
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>

  <note>
   <para>
    Les types <literal>EAN13</literal>, <literal>ISBN13</literal>, 
    <literal>ISMN13</literal> et <literal>ISSN13</literal> afficheront
    toujours la version longue d'ISxN (EAN13). La fonction d'affichage pour
    ce faire est <literal>ean13_out()</literal>.
   </para>
   <para>
    Ces types sont nécessaires pour afficher la même donnée de différentes
    façons&nbsp;: <literal>ISBN13</literal> est identique à
    <literal>ISBN</literal>, <literal>ISMN13=ISMN</literal> et
    <literal>ISSN13=ISSN</literal>.
   </para>
  </note>
 </sect2>

 <sect2>
  <title>Fonctions en entrée</title>
 
  <para>
   Voici la liste des fonctions en entrée&nbsp;:
  </para>

  <table>
   <title>Fonctions en entrée</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>Fonction</entry>
      <entry>Description</entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry><para><literal>ean13_in()</literal></para></entry>
      <entry>
       <para>
        Prend une chaîne en argument et renvoie un EAN13.
       </para>
      </entry>
     </row>

     <row>
      <entry><para><literal>isbn_in()</literal></para></entry>
      <entry>
       <para>
        Prend une chaîne en argument et renvoie un nombre ISBN ou
	ISBN13 valide.
       </para>
      </entry>
     </row>

     <row>
      <entry><para><literal>ismn_in()</literal></para></entry>
      <entry>
       <para>
        Prend une chaîne en argument et renvoie un nombre ISMN ou
	ISMN13 valide.
       </para>
      </entry>
     </row>

     <row>
      <entry><para><literal>issn_in()</literal></para></entry>
      <entry>
       <para>
        Prend une chaîne en argument et renvoie un nombre ISSN ou
	ISSN13 valide.
       </para>
      </entry>
     </row>
     <row>
      <entry><para><literal>upc_in()</literal></para></entry>
      <entry>
       <para>
        Prend une chaîne en argument et renvoie un code UPC.
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
 </sect2>

 <sect2>
  <title>Conversions</title>

  <para>
   Nous sommes capables de convertir ces types&nbsp;:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     ISBN13 -> EAN13
    </para>
   </listitem>
   <listitem>
    <para>
     ISMN13 -> EAN13
    </para>
   </listitem>
   <listitem>
    <para>
     ISSN13 -> EAN13
    </para>
   </listitem>
   <listitem>
    <para>
     ISBN -> EAN13
    </para>
   </listitem>
   <listitem>
    <para>
     ISMN -> EAN13
    </para>
   </listitem>
   <listitem>
    <para>
     ISSN -> EAN13
    </para>
   </listitem>
   <listitem>
    <para>
     UPC  -> EAN13
    </para>
   </listitem>
   <listitem>
    <para>
     ISBN &lt;-&gt; ISBN13
    </para>
   </listitem>
   <listitem>
    <para>
     ISMN &lt;-&gt; ISMN13
    </para>
   </listitem>
   <listitem>
    <para>
     ISSN &lt;-&gt; ISSN13
    </para>
   </listitem>
  </itemizedlist>
 </sect2>

 <sect2>
  <title>API C</title>
  <para>
   L'API C est implémentée ainsi&nbsp;:
  </para>
  <programlisting>
   extern Datum isn_out(PG_FUNCTION_ARGS);
   extern Datum ean13_out(PG_FUNCTION_ARGS);
   extern Datum ean13_in(PG_FUNCTION_ARGS);
   extern Datum isbn_in(PG_FUNCTION_ARGS);
   extern Datum ismn_in(PG_FUNCTION_ARGS);
   extern Datum issn_in(PG_FUNCTION_ARGS);
   extern Datum upc_in(PG_FUNCTION_ARGS);
  </programlisting>

  <para>
   En cas de succès&nbsp;:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     <literal>isn_out()</literal> prend un de nos types et renvoie une chaîne
     contenant la représentation la plus petite du nombre.
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>ean13_out()</literal> prend un de nos types et renvoie la
     représentation EAN13 (donc longue ) du nombre.
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>ean13_in()</literal> prend une chaîne et renvoie un EAN13.
     Qui, comme indiqué dans (2), pourrait être ou pas un de nos types
     mais c'est à coup sûr un nombre EAN13. Ça ne fonctionne que si la
     chaîne est un nombre EAN13 valide.
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>isbn_in()</literal> prend une chaîne et renvoie un ISBN/ISBN13.
     Ça ne fonctionne que si la chaîne est un ISBN/ISBN13.
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>ismn_in()</literal> prend une chaîne et renvoie un ISMN/ISMN13.
     Ça ne fonctionne que si la chaîne est un ISMN/ISMN13.
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>issn_in()</literal> prend une chaîne et renvoie un ISSN/ISSN13.
     Ça ne fonctionne que si la chaîne est un ISSN/ISSN13.
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>upc_in()</literal> prend une chaîne et renvoie un code UPC.
     Ça ne fonctionne que si la chaîne est un code UPC.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   (en cas d'échec, les fonctions renvoient une erreur via ereport)
  </para>
 </sect2>

 <sect2>
  <title>Fonctions de test</title>
  <table>
   <title>Fonctions de test</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry><para>Fonction</para></entry>
      <entry><para>Description</para></entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry><para><literal>isn_weak(boolean)</literal></para></entry>
      <entry><para>Configure le mode de saisie faible.</para></entry>
     </row>
     <row>
      <entry><para><literal>isn_weak()</literal></para></entry>
      <entry><para>Récupère le statut actuel du mode faible.</para></entry>
     </row>
     <row>
      <entry><para><literal>make_valid()</literal></para></entry>
      <entry><para>Valide un nombre invalide (en supprimant l'information
       d'invalidité).</para></entry>
     </row>
     <row>
      <entry><para><literal>is_valid()</literal></para></entry>
      <entry><para>Vérifie la présence de l'information
       d'invalidité.</para></entry>
     </row>
    </tbody>
   </tgroup>
  </table>

  <para>
   Le mode faible (<literal>weak</literal>) est utilisé pour pouvoir insérer
   des données invalides dans la table. Par invalide, nous entendons des
   nombres dont le chiffre de vérification est erroné.
  </para>
  <para>
   Why would you want to use the weak mode? Well, it could be that
   you have a huge collection of ISBN numbers, and that there are so many of
   them that for weird reasons some have the wrong check digit (perhaps the
   numbers where scanned from a printed list and the OCR got the numbers wrong,
   perhaps the numbers were manually captured... who knows.) Anyway, the thing
   is you might want to clean the mess up, but you still want to be able to have
   all the numbers in your database and maybe use an external tool to access
   the invalid numbers in the database so you can verify the information and
   validate it more easily; as selecting all the invalid numbers in the table.
  </para>
  <para>
   Quand vous insérez des nombres invalides dans une table en utilisant le
   mode faible, le nombre sera inséré avec le chiffre de vérification
   modifié mais il sera enregistré avec un point d'exclamation à la fin
   (par exemple 0-11-000322-5!).
  </para>
  <para>
   Vous pouvez aussi forcer l'insertion de nombres invalides, même sans le
   mode faible, en ajoutant le caractère <literal>!</literal> à la fin du
   nombre.
  </para>
 </sect2>

 <sect2>
  <title>Exemples</title>
  <programlisting>
--Using the types directly:
SELECT isbn('978-0-393-04002-9');
SELECT isbn13('0901690546');
SELECT issn('1436-4522');

--Conversions:
-- notez que vous pouvez seulement convertir d'ean13 vers les autres types
-- quand le nombre converti est valide pour ce type ;
-- du coup, ceci ne fonctionnera pas : select isbn(ean13('0220356483481')); 
-- contrairement à ceci :
SELECT upc(ean13('0220356483481')); 
SELECT ean13(upc('220356483481')); 

--Crée une table avec une seule colonne contenant des numéros ISBN :
CREATE TABLE test ( id isbn );
INSERT INTO test VALUES('9780393040029');

--Calcule automatiquement les nombres de vérification (notez le '?'):
INSERT INTO test VALUES('220500896?');
INSERT INTO test VALUES('978055215372?');

SELECT issn('3251231?');
SELECT ismn('979047213542?');

--En utilisant le mode faible :
SELECT isn_weak(true);
INSERT INTO test VALUES('978-0-11-000533-4');
INSERT INTO test VALUES('9780141219307');
INSERT INTO test VALUES('2-205-00876-X');
SELECT isn_weak(false);
  
SELECT id FROM test WHERE NOT is_valid(id);
UPDATE test SET id=make_valid(id) WHERE id = '2-205-00876-X!';
  
SELECT * FROM test;

SELECT isbn13(id) FROM test;
  </programlisting>
 </sect2>

 <sect2>
  <title>Bibliographie</title>
  <para>
   Les informations utilisées pour la création de ce module ont été récupérées
   sur différents sites&nbsp;:
  </para>
  <programlisting>
   http://www.isbn-international.org/
   http://www.issn.org/
   http://www.ismn-international.org/
   http://www.wikipedia.org/
  </programlisting>
  <para>
   Les préfixes utilisés pour les tirets ont aussi été tirés de&nbsp;:
  </para>
  <programlisting>
   http://www.gs1.org/productssolutions/idkeys/support/prefix_list.html
   http://www.isbn-international.org/en/identifiers.html
   http://www.ismn-international.org/ranges.html
  </programlisting>
  <para>
   Une attention toute particulière a été prise lors de la création des
   algorithmes et ils ont été vérifiés méticuleusement avec les algorithmes
   suggérés dans les manuels utilisateur officiels pour ISBN, ISMN, ISSN.
  </para>
 </sect2>
 
 <sect2>
  <title>Auteur</title>
  <para>
   GermÃ¡n MÃ©ndez Bravo (Kronuz), 2004 - 2006
  </para>
 </sect2>
</sect1>

