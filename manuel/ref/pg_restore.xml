<?xml version="1.0" encoding="UTF-8"?>
<!-- $Header: /var/lib/cvs/pgsql-fr/sgml/ref/pg_restore.sgml,v 1.9 2005/09/15 07:03:27 guillaume Exp $ -->

<refentry id="app-pgrestore">
 <refmeta>
  <refentrytitle>pg_restore</refentrytitle>
  <manvolnum>1</manvolnum>
  <refmiscinfo>Application</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>pg_restore</refname>

  <refpurpose>
   restaure une base de données <productname>PostgreSQL</productname> à partir
   d'un fichier d'archive créé par pg_dump
  </refpurpose>
 </refnamediv>

 <refsynopsisdiv>
  <cmdsynopsis>
   <command>pg_restore</command>
   <arg rep="repeat"><replaceable>option</replaceable></arg>
   <arg><replaceable>nom_fichier</replaceable></arg>
  </cmdsynopsis>
 </refsynopsisdiv>

 <refsect1 id="app-pgrestore-description">
  <title>Description</title>
  <indexterm zone="app-pgrestore">
   <primary>pg_restore</primary>
  </indexterm>

  <para>
   <application>pg_restore</application> est un outil pour restaurer une base de
   données <productname>PostgreSQL</productname> à partir d'une archive créée
   par <xref linkend="app-pgdump"/> dans un des formats non textuel. Il lance
   les commandes nécessaires pour reconstruire la base de données dans l'état où
   elle était au moment de sa sauvegarde. Les fichiers d'archive permettent
   aussi à <application>pg_restore</application> d'être sélectif sur ce qui est
   restauré ou même de réordonner les éléments à restaurer. Les
   fichiers d'archive sont conçus pour être portables entre les
   architectures.
  </para>

  <para>
   <application>pg_restore</application> peut opérer dans deux modes. Si un nom
   de base de données est spécifié, <application>pg_restore</application> se
   connecte à cette base de données et restaure l'archive directement dans la
   base de données. Sinon, un script contenant les commandes SQL nécessaires
   pour reconstruire la base de données est créé et écrit dans un fichier ou
   sur la sortie standard. Cette sortie du script est équivalente à celles créées
   par le format en texte plein de <application>pg_dump</application>.
   Quelques-unes des options contrôlant la sortie sont du coup analogues aux
   options de <application>pg_dump</application>.
  </para>

  <para>
   De toute évidence, <application>pg_restore</application> ne peut pas
   restaurer l'information qui ne se trouve pas dans le fichier d'archive.  Par
   exemple, si l'archive a été réalisée en utilisant l'option donnant les
   <quote>données sauvegardées par des commandes
   <command>INSERT</command></quote>, <application>pg_restore</application> ne
   sera pas capable de charger les données en utilisant des instructions
   <command>COPY</command>.
  </para>
 </refsect1>

 <refsect1 id="app-pgrestore-options">
  <title>Options</title>

   <para>
    <application>pg_restore</application> accepte les arguments suivants en ligne
    de commande.

    <variablelist>
     <varlistentry>
      <term><replaceable class="parameter">nom_fichier</replaceable></term>
      <listitem>
       <para>
       Spécifie l'emplacement du fichier d'archive à restaurer. S'il n'est pas
       spécifié, l'entrée standard est utilisée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-a</option></term>
      <term><option>--data-only</option></term>
      <listitem>
       <para>
	Restaure seulement les données, pas les schémas (définitions des données).
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-c</option></term>
      <term><option>--clean</option></term>
      <listitem>
       <para>
	Nettoie (supprime) les objets de la base de données avant de les créer.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-C</option></term>
      <term><option>--create</option></term>
      <listitem>
       <para>
        Crée la base de données avant de la restaurer. (Quand cette option est
        utilisée, la base de données nommée avec <option>-d</option> est
        utilisée seulement pour lancer la commande initiale <command>CREATE
        DATABASE</command>. Toutes les données sont restaurées dans le nom de la base
        de données qui apparaît dans l'archive.)
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-d <replaceable
	class="parameter">nom_base</replaceable></option></term>
      <term><option>--dbname=<replaceable
	class="parameter">nom_base</replaceable></option></term>
      <listitem>
       <para>
        Se connecte à la base de données <replaceable
        class="parameter">nom_base</replaceable> et restaure directement dans la
	base de données.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-e</option></term>
      <term><option>--exit-on-error</option></term>
      <listitem>
       <para>
        Quitte si une erreur est rencontrée lors de l'envoi des commandes SQL à
	la base de données. La valeur par défaut est de continuer et d'afficher
	le nombre d'erreurs à la fin de la restauration.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-f <replaceable>nom_fichier</replaceable></option></term>
      <term><option>--file=<replaceable>filename</replaceable></option></term>
      <listitem>
       <para>
        Spécifie le fichier en sortie pour le script généré ou pour la liste
        lorsqu'elle est utilisée avec <option>-l</option>. Par défaut, il s'agit
        de la sortie standard.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-F <replaceable class="parameter">format</replaceable></option></term>
      <term><option>--format=<replaceable class="parameter">format</replaceable></option></term>
      <listitem>
       <para>
        Spécifie le format de l'archive. Il n'est pas nécessaire de le
	spécifier car <application>pg_restore</application> détermine le
	format automatiquement. Si spécifié, il peut être un des suivants&nbsp;:

       <variablelist>
        <varlistentry>
         <term><literal>t</literal></term>
         <term><literal>tar</literal></term>
         <listitem>
          <para>
           L'archive est une archive <command>tar</command>.
          </para>
         </listitem>
        </varlistentry>

        <varlistentry>
         <term><literal>c</literal></term>
	 <term><literal>custom</literal></term>
         <listitem>
          <para>
           L'archive est dans le format personnalisé de
           <application>pg_dump</application>.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-i</option></term>
      <term><option>--ignore-version</option></term>
      <listitem>
       <para>
	Ignore la vérification de version de la base de données.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-I <replaceable class="parameter">index</replaceable></option></term>
      <term><option>--index=<replaceable class="parameter">index</replaceable></option></term>
      <listitem>
       <para>
	Restaure uniquement la définition des index nommés.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-l</option></term>
      <term><option>--list</option></term>
      <listitem>
       <para>
        Liste le contenu de l'archive. La sortie de cette opération peut être
        utilisée comme entrée de l'option <option>-L</option>. Notez que si
        des options de filtre comme <option>-n</option> ou <option>-t</option> sont
        utilisées avec <option>-l</option>, elles réduisent les éléments listés.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-L <replaceable
	class="parameter">fichier_liste</replaceable></option></term>
      <term><option>--use-list=<replaceable
	class="parameter">fichier_liste</replaceable></option></term>
      <listitem>
       <para>
        Restaure seulement les éléments de l'archive qui sont listés dans
        <replaceable class="PARAMETER">fichier-liste</replaceable>, et les
        restaure dans l'ordre dans lequel ils apparaissent dans le fichier.
        Notez que, si des options de filtre comme <option>-n</option> ou
        <option>-t</option> sont utilisées avec <option>-L</option>, elles
        réduisent les éléments restaurés.
       </para>
       <para>
        <replaceable class="PARAMETER">fichier-liste</replaceable> est habituellement créé
        en éditant la sortie d'une opération <option>-l</option> précédente. Les
        lignes peuvent être déplacées ou supprimées, et peuvent aussi être
        commentées en plaçant un point-virgule (<literal>;</literal>) au début
        de la ligne. Voir ci-dessous pour des exemples.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-n <replaceable class="parameter">nom_schema</replaceable></option></term>
      <term><option>--schema=<replaceable class="parameter">nom_schema</replaceable></option></term>
      <listitem>
       <para>
	Restaure seulement les objets qui sont dans le schéma nommé. Elle
	peut être combinée avec l'option <option>-t</option> pour ne restaurer
	qu'une seule table.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-O</option></term>
      <term><option>--no-owner</option></term>
      <listitem>
       <para>
        Ne pas donner les commandes initialisant les propriétaires des objets
        pour correspondre à la base de données originale. Par défaut, 
        <application>pg_restore</application> lance des instructions
	<command>ALTER OWNER</command> ou <command>SET SESSION
	AUTHORIZATION</command> pour configurer le propriétaire des éléments du
	schéma créé. Ces instructions échouent sauf si la connexion initiale à
	la base de données est réalisée par un superutilisateur (ou le même
	utilisateur que le propriétaire des objets du script). Avec
	<option>-O</option>, tout nom d'utilisateur peut être utilisé pour la
	connexion initiale et cet utilisateur est le propriétaire des objets
	créés.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-P <replaceable class="parameter">nom_fonction(argtype [,
	...])</replaceable></option></term>
      <term><option>--function=<replaceable
	class="parameter">nom_fonction(argtype [,
	...])</replaceable></option></term>
      <listitem>
       <para>
        Restaure seulement la fonction nommée. Faites attention à épeler le
        nom de la fonction et les arguments exactement comme ils apparaissent
        dans la table des matières du fichier de sauvegarde.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-r</option></term>
      <term><option>--no-reconnect</option></term>
      <listitem>
       <para>
        Cette option est obsolète mais est toujours acceptée pour des raisons
	de compatibilité ascendante.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-s</option></term>
      <term><option>--schema-only</option></term>
      <listitem>
       <para>
        Restaure uniquement le schéma (définition des données), et non pas les
	données elles-même (contenu de la table). Les valeurs actuelles des
	séquences ne seront pas restaurées. À ne pas confondre avec l'option
	<option>--schema</option> qui utilise le mot schéma avec une autre
	signification).
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-S <replaceable
	class="parameter">nom_utilisateur</replaceable></option></term>
      <term><option>--superuser=<replaceable
	class="parameter">nom_utilisateur</replaceable></option></term>
      <listitem>
       <para>
        Spécifie le nom d'utilisateur du superutilisateur à utiliser pour
	désactiver les déclencheurs. Ceci est seulement nécessaire si
	<option>--disable-triggers</option> est utilisé.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-t <replaceable class="parameter">table</replaceable></option></term>
      <term><option>--table=<replaceable class="parameter">table</replaceable></option></term>
      <listitem>
       <para>
        Restaure uniquement la définition et/ou les données de la table nommée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-T <replaceable class="parameter">trigger</replaceable></option></term>
      <term><option>--trigger=<replaceable class="parameter">trigger</replaceable></option></term>
      <listitem>
       <para>
        Restaure uniquement le déclencheur nommé.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-v</option></term>
      <term><option>--verbose</option></term>
      <listitem>
       <para>
	Spécifie le mode verbeux.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-x</option></term>
      <term><option>--no-privileges</option></term>
      <term><option>--no-acl</option></term>
      <listitem>
       <para>
        Empêche la restauration des droits d'accès (commandes grant/revoke).
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--disable-triggers</option></term>
      <listitem>
       <para>
        Cette option n'est pertinente que lors d'une restauration des 
        données seules.
	Elle demande à <application>pg_restore</application>
	d'exécuter des commandes pour désactiver temporairement les déclencheurs
	sur les tables cibles pendant que les données sont rechargées. Utilisez ceci
	si vous avez des vérifications d'intégrité référentielle sur les tables
	que vous ne voulez pas appeler lors du rechargement des données.
       </para>

       <para>
        Actuellement, les commandes émises pour <option>--disable-triggers</option>
	doivent être exécutées par un superutilisateur. Donc, vous devriez aussi
	spécifier un nom de superutilisateur avec <option>-S</option> ou, de
	préférence, lancer <application>pg_restore</application> en tant que
	superutilisateur <productname>PostgreSQL</productname>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--use-set-session-authorization</option></term>
      <listitem>
       <para>
        Affiche les commandes <command>SET SESSION AUTHORIZATION</command> du
        standard SQL à la place des commandes <command>ALTER OWNER</command>
        pour déterminer le propriétaire de l'objet. Ceci rend la sauvegarde
        plus compatible avec les standards mais, suivant l'historique des
        objets dans la sauvegarde, pourrait restaurer correctement.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--no-data-for-failed-tables</option></term>
      <listitem>
       <para>
        Par défaut, les données de la table sont restaurées même si la commande
        de création de cette table a échoué (par exemple parce qu'elle existe
        déjà). Avec cette option, les données de cette table seront ignorées.
        Ce comportement est utile quand la base cible contient déjà des données
        pour cette table. Par exemple, les tables supplémentaires des
        extensions de <productname>PostgreSQL</productname> comme
        <productname>PostGIS</productname> pourraient avoir déjà été créées et
        remplies sur la base cible&nbsp;; indiquer cette option empêche l'ajout
        de données dupliquées ou obsolètes.
       </para>

       <para>
        Cette option est seulement efficace lors de la restauration directe
        d'une base, pas lors de la réalisation d'une sortie de script SQL.
       </para>
      </listitem>
     </varlistentry>

    </variablelist>
   </para>

   <para>
    <application>pg_restore</application> accepte aussi les arguments suivants
    en ligne de commande pour les paramètres de connexion&nbsp;:

    <variablelist>
     <varlistentry>
      <term><option>-h <replaceable
	class="parameter">hôte</replaceable></option></term>
      <term><option>--host=<replaceable
	class="parameter">hôte</replaceable></option></term>
      <listitem>
       <para>
	Spécifie le nom d'hôte de la machine sur lequel le serveur est en 
	cours d'exécution. Si la valeur commence par un slash, elle est utilisée
	comme répertoire du socket de domaine Unix. La valeur par défaut est
	prise dans la variable d'environnement <envar>PGHOST</envar>, si elle
	est initialisée, sinon une connexion socket de domaine Unix est tentée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-p <replaceable class="parameter">port</replaceable></option></term>
      <term><option>--port=<replaceable class="parameter">port</replaceable></option></term>
      <listitem>
       <para>
	Spécifie le port TCP ou l'extension du fichier socket de domaine Unix
	sur lequel le serveur écoute les connexions. Par défaut, l'outil utilise
	la variable d'environnement <envar>PGPORT</envar>, si elle est
	configurée, sinon il utilise la valeur indiquée à la compilation.
        </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-U
	<replaceable>nom_utilisateur</replaceable></option></term>
      <listitem>
       <para>
        Se connecte en tant que cet utilisateur
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-W</option></term>
      <listitem>
       <para>
        Force une demande de mot de passe. Ceci devrait arriver automatiquement
	    si le serveur requiert une authentification par mot de passe.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-1</option></term>
      <term><option>--single-transaction</option></term>
      <listitem>
       <para>
        Exécute la restauration en une seule transaction (c'est-à-dire qu'elle
	    entoure les commandes de restauration par les commandes
	    <command>BEGIN</command>/<command>COMMIT</command>). Ceci vous assure
	    que soit toutes les commandes terminent avec succès soit aucune
	    modification n'a lieu. Cette option implique
	    <option>--exit-on-error</option>.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </para>
 </refsect1>


 <refsect1>
  <title>Environnement</title>

  <variablelist>
   <varlistentry>
    <term><envar>PGHOST</envar></term>
    <term><envar>PGPORT</envar></term>
    <term><envar>PGUSER</envar></term>

    <listitem>
     <para>
      Paramètres de connexion par défaut
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Cet outil, comme la plupart des autres outils <productname>PostgreSQL</productname>,
   utilise aussi les variables d'environnement supportées par la bibliothèque
   <application>libpq</application> (voir <xref linkend="libpq-envars"/>).
  </para>

 </refsect1>


 <refsect1 id="app-pgrestore-diagnostics">
  <title>Diagnostiques</title>

  <para>
   Quand une connexion directe à la base de données est spécifiée avec l'option
   <option>-d</option>, <application>pg_restore</application> exécute en
   interne des instructions <acronym>SQL</acronym>. Si vous avez des problèmes
   en exécutant <application>pg_restore</application>, assurez-vous d'être
   capable de sélectionner des informations à partir de la base de données
   en utilisant, par exemple à partir de <xref linkend="app-psql"/>. De plus,
   tout paramètre de connexion par défaut et toute variable d'environnement
   utilisé par la bibliothèque <application>libpq</application> s'appliqueront.
  </para>
 </refsect1>


 <refsect1 id="app-pgrestore-notes">
  <title>Notes</title>

  <para>
   Si votre installation dispose d'ajouts locaux à la base de données
   <literal>template1</literal>, faites attention à charger la sortie de
   <application>pg_restore</application> dans une base de données réellement
   vide&nbsp;; sinon, vous avez des risques d'obtenir des erreurs dûes aux
   définitions dupliquées des objets ajoutés. Pour créer une base de données
   vide sans ajout local, copiez à partir de <literal>template0</literal>, et non pas
   de <literal>template1</literal>, par exemple&nbsp;:
<programlisting>CREATE DATABASE foo WITH TEMPLATE template0;
</programlisting>
  </para>

  <para>
   Les limitations de <application>pg_restore</application> sont détaillées
   ci-dessous.

   <itemizedlist>
    <listitem>
     <para>
      Lors de la restauration des données dans une table pré-existante et que
      l'option <option>--disable-triggers</option> est utilisée,
      <application>pg_restore</application> émet des commandes pour désactiver
      les déclencheurs sur les tables utilisateur avant d'insérer les données,
      puis émet les commandes pour les réactiver après l'insertion des données.
      Si la restauration est stoppée en plein milieu, les catalogues système
      pourraient être abandonnés dans le mauvais état.
     </para>
    </listitem>

    <listitem>
     <para>
      <application>pg_restore</application> ne restaure pas les objets 
      larges pour une seule table. Si une archive contient des objets larges,
      alors ils sont tous restaurés.
     </para>
    </listitem>

   </itemizedlist>
  </para>

  <para>
   Voir aussi la documentation de <xref linkend="app-pgdump"/> pour les détails
   sur les limitations de <application>pg_dump</application>.
  </para>

  <para>
   Une fois la restauration terminée, il est conseillé de lancer <command>ANALYZE</command> sur
   chaque table restaurée de façon à ce que l'optimiseur dispose de statistiques
   utiles.
  </para>

 </refsect1>


 <refsect1 id="app-pgrestore-examples">
  <title>Exemples</title>

  <para>
   Supposons que nous avons sauvegardé une base nommée <literal>ma_base</literal>
   dans un fichier de sauvegarde au format personnalisé&nbsp;:

<screen>
<prompt>$</prompt> <userinput>pg_dump -Fc ma_base &gt; ma_base.dump</userinput>
</screen>
  </para>

  <para>
   Pour supprimer la base et la re-créer à partir de la sauvegarde&nbsp;:

<screen>
<prompt>$</prompt> <userinput>dropdb ma_base</userinput>
<prompt>$</prompt> <userinput>pg_restore -C -d postgres ma_base.dump</userinput>
</screen>

   La base nommée avec l'option <option>-d</option> peut être toute base de
   données existante dans le cluster&nbsp;; <application>pg_restore</application>
   l'utilise seulement pour exécuter la commande <command>CREATE
   DATABASE</command> pour <literal>ma_base</literal>.  Avec
   <option>-C</option>, les données sont toujours restaurées dans le nom de la
   base qui apparaît dans le fichier de sauvegarde.
  </para>

  <para>
   Pour charger la sauvegarde dans une nouvelle base nommée
   <literal>nouvelle_base</literal>&nbsp;:

<screen>
<prompt>$</prompt> <userinput>createdb -T template0 newdb</userinput>
<prompt>$</prompt> <userinput>pg_restore -d newdb db.dump</userinput>
</screen>

   Notez que nous n'utilisons pas <option>-C</option> et que nous nous sommes
   connectés directement sur la base à restaurer. De plus, notez que nous clonons
   la nouvelle base à partir de <literal>template0</literal> et non pas de
   <literal>template1</literal>, pour s'assurer qu'elle est vide.
  </para>

  <para>
   Pour réordonner les éléments de la base de données, il est tout d'abord
   nécessaire de sauvegarder la table des matières de l'archive&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_restore -l ma_base.dump &gt; ma_base.liste</userinput>
</screen>
   Le fichier de liste consiste en un en-tête et d'une ligne par élément, par
   exemple
<programlisting>;
; Archive created at Fri Jul 28 22:28:36 2000
;     dbname: ma_base
;     TOC Entries: 74
;     Compression: 0
;     Dump Version: 1.4-0
;     Format: CUSTOM
;
;
; Selected TOC Entries:
;
2; 145344 TABLE species postgres
3; 145344 ACL species
4; 145359 TABLE nt_header postgres
5; 145359 ACL nt_header
6; 145402 TABLE species_records postgres
7; 145402 ACL species_records
8; 145416 TABLE ss_old postgres
9; 145416 ACL ss_old
10; 145433 TABLE map_resolutions postgres
11; 145433 ACL map_resolutions
12; 145443 TABLE hs_old postgres
13; 145443 ACL hs_old
</programlisting>
   Les points virgules commencent un commentaire et les numéros au début des
   lignes se réfèrent à l'ID d'archive interne affectée à chaque élément.
  </para>

  <para>
   Les lignes dans le fichier peuvent être commentées, supprimées et
   réordonnées. Par exemple,
<programlisting>10; 145433 TABLE map_resolutions postgres
;2; 145344 TABLE species postgres
;4; 145359 TABLE nt_header postgres
6; 145402 TABLE species_records postgres
;8; 145416 TABLE ss_old postgres
</programlisting>
   peut être utilisé en entrée de <application>pg_restore</application> et
   ne restaure que les éléments 10 et 6 dans cet ordre&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_restore -L mabase.liste mabase.fichier</userinput>
</screen>
  </para>

 </refsect1>

 <refsect1>
  <title>Historique</title>

  <para>
   L'outil <application>pg_restore</application> est apparu dans
   <productname>PostgreSQL</productname> version 7.1.
  </para>
 </refsect1>

 <refsect1>
  <title>Voir aussi</title>

  <simplelist type="inline">
   <member><xref linkend="app-pgdump"/></member>
   <member><xref linkend="app-pg-dumpall"/></member>
   <member><xref linkend="app-psql"/></member>
  </simplelist>
 </refsect1>
</refentry>
