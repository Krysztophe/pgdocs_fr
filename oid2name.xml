<sect1 id="oid2name">
 <title>oid2name</title>
 
 <indexterm zone="oid2name">
  <primary>oid2name</primary>
 </indexterm>

 <para>
  Cet outil permet aux administrateurs d'examiner la structure de fichiers
  utilisée par PostgreSQL. Pour l'utiliser, vous devez être familier avec
  la structure des fichiers décrite dans <xref linkend="storage"/>.
 </para>
 
 <sect2>
  <title>Aperçu</title>
  <para>
   <literal>oid2name</literal> se connecte à la base de données et récupère
   les OID, filenode et noms de table. Vous pouvez aussi affcher les OID des
   bases et des tablespaces.
  </para>
  <para>
   Lors de l'affichage de tables spécifiques, vous pouvez sélectionner les
   tables à afficher avec les options -o, -f et -t. La première option prend
   un OID, la seconde un filenode, et la troisième un nom de table
   (en fait, c'est un modèle pour LIKE donc vous pouvez utiliser un texte
   comme <quote>foo%</quote>). Notez que vous pouvez utiliser autant de fois
   que vous voulez les différentes options. Le résultat incluera tous les
   objets correspondant à une des options. De plus, notez que ces options
   peuvent seulement affichées les objets de la base indiquée par l'option
   -d.
  </para>
  <para>
   Si vous ne passez pas les options -o, -f ou -t, il affichera toutes les
   tables de la base indiquée par l'option -d. Si vous ne passez pas non plus
   l'option -d, il affichera une liste des bases de données. Autrement,
   vous pouvez passer -s pour obtenir une liste des tablespaces.
  </para>
  <table>
   <title>Options supplémentaires</title>
   <tgroup cols="2">
    <tbody>
     <row>
      <entry><literal>-i</literal></entry>
      <entry>inclut les index et séquences dans l'affichage de la base.</entry>
     </row>
     <row>
      <entry><literal>-x</literal></entry>
      <entry>affiche plus d'informations sur chaque objet affiché&nbsp;:
       nom du tablespace, nom du schéma, OID.
      </entry>
     </row>
     <row>
      <entry><literal>-S</literal></entry>
      <entry>affiche aussi les objets système (ceux compris dans
       information_schema, pg_toast et pg_catalog schemas)
      </entry>
     </row>
     <row>
      <entry><literal>-q</literal></entry>
      <entry>n'affiche pas les en-têtes (utile pour les scripts)</entry>
     </row>
    </tbody>
   </tgroup>
  </table>
 </sect2>
 
 <sect2>
  <title>Exemples</title>
 
  <programlisting>
$ oid2name
All databases:
    Oid  Database Name  Tablespace
----------------------------------
  17228       alvherre  pg_default
  17255     regression  pg_default
  17227      template0  pg_default
      1      template1  pg_default

$ oid2name -s
All tablespaces:
     Oid  Tablespace Name
-------------------------
    1663       pg_default
    1664        pg_global
  155151         fastdisk
  155152          bigdisk

$ cd $PGDATA/17228

$ # obtenir les 10 objets de la base de données, tablespace par défaut,
$ # classés par taille
$ ls -lS * | head -10
-rw-------  1 alvherre alvherre 136536064 sep 14 09:51 155173
-rw-------  1 alvherre alvherre  17965056 sep 14 09:51 1155291
-rw-------  1 alvherre alvherre   1204224 sep 14 09:51 16717
-rw-------  1 alvherre alvherre    581632 sep  6 17:51 1255
-rw-------  1 alvherre alvherre    237568 sep 14 09:50 16674
-rw-------  1 alvherre alvherre    212992 sep 14 09:51 1249
-rw-------  1 alvherre alvherre    204800 sep 14 09:51 16684
-rw-------  1 alvherre alvherre    196608 sep 14 09:50 16700
-rw-------  1 alvherre alvherre    163840 sep 14 09:50 16699
-rw-------  1 alvherre alvherre    122880 sep  6 17:51 16751

$ oid2name -d alvherre -f 155173
From database "alvherre":
  Filenode  Table Name
----------------------
    155173    accounts

$ # vous pouvez demander plus d'un objet
$ oid2name -d alvherre -f 155173 -f 1155291
From database "alvherre":
  Filenode     Table Name
-------------------------
    155173       accounts
   1155291  accounts_pkey

$ # vous pouvez aussi mixer les options et avoir plus de détails
$ oid2name -d alvherre -t accounts -f 1155291 -x
From database "alvherre":
  Filenode     Table Name      Oid  Schema  Tablespace
------------------------------------------------------
    155173       accounts   155173  public  pg_default
   1155291  accounts_pkey  1155291  public  pg_default

$ # affiche l'espace disque de chaque objet de la base
$ du [0-9]* |
> while read SIZE FILENODE
> do
>   echo "$SIZE       `oid2name -q -d alvherre -i -f $FILENODE`"
> done
16            1155287  branches_pkey
16            1155289  tellers_pkey
17561            1155291  accounts_pkey
...

$ # idem mais trié par taille
$ du [0-9]* | sort -rn | while read SIZE FN
> do
>   echo "$SIZE   `oid2name -q -d alvherre -f $FN`"
> done
133466             155173    accounts
17561            1155291  accounts_pkey
1177              16717  pg_proc_proname_args_nsp_index
...

$ # Si vous voulez voir le contenu des tablespaces, utilisez le répertoire
$ # pg_tblspc
$ cd $PGDATA/pg_tblspc
$ oid2name -s
All tablespaces:
     Oid  Tablespace Name
-------------------------
    1663       pg_default
    1664        pg_global
  155151         fastdisk
  155152          bigdisk

$ # quelles bases a des objets dans le tablespace nommé fastdisk ?
$ ls -d 155151/*
155151/17228/  155151/PG_VERSION

$ # Oh, mais quelle est la base de données 17228 ?
$ oid2name   
All databases:
    Oid  Database Name  Tablespace
----------------------------------
  17228       alvherre  pg_default
  17255     regression  pg_default
  17227      template0  pg_default
      1      template1  pg_default

$ # Voyons les objets que cette base a dans le tablespace.
$ cd 155151/17228
$ ls -l
total 0
-rw-------  1 postgres postgres 0 sep 13 23:20 155156

$ # OK, c'est une très petite table... mais laquelle est-ce ?
$ oid2name -d alvherre -f 155156
From database "alvherre":
  Filenode  Table Name
----------------------
    155156         foo

$ # fin de la session d'exemple.
  </programlisting>

  <para>
   Vous pouvez aussi obtenir la taille approximative des données pour
   chaque objet en utilisant psql. Par exemple&nbsp;:
  </para>
  <programlisting>
   SELECT relpages, relfilenode, relname FROM pg_class ORDER BY relpages DESC;
  </programlisting>
  <para>
   Chaque page fait typiquement 8&nbsp;Ko. Le champ relpages est mis à jour
   par VACUUM.
  </para>
 </sect2>
 
 <sect2>
  <title>Auteur</title>
  <para>
   b. palmer, <email>bpalmer@crimelabs.net</email>
  </para>
 </sect2>

</sect1>

