
<sect1 id="pgstandby">
 <title>pg_standby</title>
 
 <indexterm zone="pgstandby">
  <primary>pg_standby</primary>
 </indexterm>

 <para>
  <literal>pg_standby</literal> facilite la création d'un serveur en attente
  (<foreignphrase>Warm Standby</foreignphrase> ou <foreignphrase>Log
  Shipping</foreignphrase>). D'autres configurations sont aussi nécessaires,
  elles sont décrites dans le manuel du serveur principal.
 </para>
 <para>
  Le programme est conçu pour être la commande de
  <literal>restore_command</literal>, requis pour transformation une
  restauration d'archive normal en un serveur Warm Standby. Dans le
  paramètre <literal>restore_command</literal> de
  <literal>recovery.conf</literal>, vous pouvez configurer
  <literal>pg_standby</literal> de la façon suivante&nbsp;:
 </para>
 <programlisting>
   restore_command = 'pg_standby archiveDir %f %p'
 </programlisting>
 <para>
  qui devrait suffire pour définir les fichiers à restaurer à partir de
  archiveDir.
 </para>

 <para>
  Les fonctionnalités de <literal>pg_standby</literal> incluent&nbsp;:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Il est écrit en C, donc il est très portable et facile à installer.
   </para>
  </listitem>
  <listitem>
   <para>
    Il supporte la copie et la création de lien à partir d'un répertoire
    (seulement)
   </para>
  </listitem>
  <listitem>
   <para>
    Les sources sont faciles à modifier avec des sections conçues
    spécialement pour être modifié selon vos propres besoins, permettant
    l'écriture d'interfaces pour des systèmes supplémentaires de restauration
    d'archives de sauvegarde (<acronym>BAR</acronym>, acronyme de
    <foreignphrase>Backup Archive Restore</foreignphrase>).
   </para>
  </listitem>
  <listitem>
   <para>
    Déjà testé sur Linux et Windows 
   </para>
  </listitem>
 </itemizedlist>

 <sect2>
  <title>Utilisation</title>
  <para>
   <literal>pg_standby</literal> doit être utilisé au niveau du paramètre
   <literal>restore_command</literal> du fichier
   <literal>recovery.conf</literal>.
  </para>
  <para>
   L'utilisation de base ressemble à ceci&nbsp;:
  </para>
  <programlisting>
   restore_command = 'pg_standby archiveDir %f %p'
  </programlisting>
  <para>
   avec la commande pg_standby&nbsp;:
  </para>
  <programlisting>
   pg_standby [OPTION]... [ARCHIVELOCATION] [NEXTWALFILE] [XLOGFILEPATH]
  </programlisting>
  <para>
   Quand les macros %f et %p sont utilisées avec le paramètre
   <literal>restore_command</literal>, les macros sont remplacés par
   le fichier et son chemin, requis pour la restauration.
  </para>

  <table>
   <title>Options</title>
   <tgroup cols="2">
    <tbody>
     <row>
      <entry>-c</entry>
      <entry>Utilise la commande copy/cp pour copier les fichiers WAL à
       partir de l'archive.</entry>
     </row>
     <row>
      <entry>-d</entry>
      <entry>option de débogage et de traces.</entry>
     </row>
     <row>
      <entry>-k nbfichiers</entry>
      <entry>
       <para>
        Nettoie les fichiers dans l'archive pour ne pas maintenir plus
	de ce nombre de fichiers dans l'archive.
       </para>
       <para>
        Vous devez faire particulièrement attention à ne pas configurer ce
	paramètre trop bas car cela pourrait signifier que vous ne pourrez
	pas relancer le serveur en attente. Ceci est dû au fait que le
	dernier restartpoint marqué dans les fichiers WAL peut être
	très éloigné dans le temps et peut varier considérablement. Ce
	paramètre doit être initialisé à une valeur dépassant le nombre
	de fichiers WAL pouvant être récupéré en 2*checkpoint_timeout
	secondes, suivant la valeur du postgresql.conf du serveur en
	attente. Ceci n'a rien à voir avec la valeur du paramètre
	checkpoint_segments sur le primaire ou le secondaire.
       </para>
       <para>
        En cas de doute, utilisez une valeur importante ou ne configurez
	rien à ce niveau-là.
       </para>
      </entry>
     </row>
     <row>
      <entry>-l</entry>
      <entry>
       <para>
        Utilise la commande ln poru copier les fichiers WAL à partir de
	l'archive pour que les fichiers WAL restent dans l'archive.
       </para>
       <para>
        Le lien est plus efficace mais la valeur par défaut est la copie pour
	vous permettre de maintenir une archive des WAL dans un but de
	récupération et de haute disponibilité.
       </para>
       <para>
        Cette option utilise la commande mklink de Windows Vista pour
	proposer la fonctionnalité du lien symbolique de fichier à fichier.
        -l ne fonctionnera pas sur les anciennes versions de Windows. Utilisez
	l'option -c à la place.
        Voir <ulink url="http://en.wikipedia.org/wiki/NTFS_symbolic_link"></ulink>
       </para>
      </entry>
     </row>
     <row>
      <entry>-r maxretries</entry>
      <entry>
       <para>
        Nombre maximum de tentatives sur la commande de restauration si
	elle échoue. Après chaque échec, nous attendons sleeptime * num_retries
	pour que le temps d'attente croisse progressivement, donc, par
	défaut, nous attendrons cinq secondes, puis 10 et enfin 15 avant de
	rapporter l'échec au serveur. Ceci sera interprété comme une fin de
	restauration et le serveur en attente deviendra du coup complètement
	disponible. Par défaut, <literal>3</literal>.
       </para>
      </entry>
     </row>
     <row>
      <entry>-s sleeptime</entry>
      <entry>
       Nombre de secondes d'attente entre les tests de vérification de la
       présence du fichier à restaurer. La valeur par défaut n'est pas
       nécessairement recommandée, consultez le manuel du serveur pour
       plus d'informations.
       Par défaut, <literal>5</literal>
      </entry>
     </row>
     <row>
      <entry>-t triggerfile</entry>
      <entry>
       La présence du fichier trigger cause la fin de la restauration, que
       le prochain fichier WAL soit disponible ou non. L'utilisation
       d'un nom de fichier structuré est recommandé pour éviter la
       confusion sur le serveur a déclenché quand plusieurs serveurs
       existent sur le même système.
       Par exemple, /tmp/pgsql.trigger.5432
      </entry>
     </row>
     <row>
      <entry>-w maxwaittime</entry>
      <entry>
       Le nombre maximum de secondes à attendre pour le prochain fichier,
       après quoi la restauration sera arrêtée et le serveur en attente
       deviendra disponible. La configuration par défaut n'est pas
       nécessairement recommandée, consultez le manuel du serveur pour
       une discussion.
       Par défaut, <literal>0</literal>.
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
  <note>
   <para>
    <literal>--help</literal> n'est pas supporté car
    <literal>pg_standby</literal> n'a pas pour but d'être utilisé de façon
    interactive, sauf pendant le développement et les tests.
   </para>
  </note>
 </sect2>

 <sect2>
  <title>Exemples</title>

  <itemizedlist>
   <listitem>
    <para>Exemple sur Linux</para>
    <programlisting>
archive_command = 'cp %p ../archive/%f'

restore_command = 'pg_standby -l -d -k 255 -r 2 -s 2 -w 0 -t /tmp/pgsql.trigger.5442 $PWD/../archive %f %p 2>> standby.log' 
    </programlisting>
    <para>
     qui va
    </para>
    <itemizedlist>
     <listitem><para>utiliser la commande ln pour établir un lien vers les
       fichiers WAL de l'archive</para></listitem>
     <listitem><para>produire des traces dans standby.log</para></listitem>
     <listitem><para>garder les 255 derniers fichiers WAL complets, sans
       parler de celui en cours d'utilisation</para></listitem>
     <listitem><para>dormir deux secondes entre chaque vérification pour
       savoir si le dernier fichier WAL est complet</para></listitem>
     <listitem><para>ne pas s'arrêter si le fichier n'est pas
       trouvé</para></listitem>
     <listitem><para>arrêter d'attendre quand le fichier trigger
       /tmp.pgsql.trigger.5442 sera créé</para></listitem>
    </itemizedlist>
   </listitem>

   <listitem>
    <para>
     Exemple sur Windows
    </para>
    <programlisting>
archive_command = 'copy %p ..\\archive\\%f'
    </programlisting>
    <para>
     Notez que les antislashs doivent être doublés dans archive_command, mais
     pas dans restore_command, en 8.2, 8.1, 8.0 sur Windows.
    </para>
    <programlisting>
restore_command = 'pg_standby -c -d -s 5 -w 0 -t C:\pgsql.trigger.5442
 ..\archive %f %p 2>> standby.log'
    </programlisting>
    <para>
     qui va
    </para>
   <itemizedlist>
     <listitem><para>utiliser la commande copy pour copier les fichiers
       WAL à partir de l'archive</para></listitem>
     <listitem><para>produire des traces dans standby.log</para></listitem>
     <listitem><para>dormir cinq secondes entre chaque vérification pour
       savoir si le dernier fichier WAL est complet</para></listitem>
     <listitem><para>ne pas s'arrêter si le fichier n'est pas
       trouvé</para></listitem>
     <listitem><para>arrêter d'attendre quand le fichier trigger
       C:\pgsql.trigger.5442 sera créé</para></listitem>
    </itemizedlist>
   </listitem>
  </itemizedlist>
 </sect2>
 
</sect1>

