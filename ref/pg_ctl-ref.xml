<?xml version="1.0" encoding="UTF-8"?>
<!-- Dernière modification
     le       $Date$
     par      $Author$
     révision $Revision$ -->
<!-- SAS 20060808 : Relecture initiale -->

<refentry id="app-pg-ctl">
 <refmeta>
  <refentrytitle id="app-pg-ctl-title"><application>pg_ctl</application></refentrytitle>
  <manvolnum>1</manvolnum>
  <refmiscinfo>Application</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>pg_ctl</refname>
  <refpurpose>démarrer, arrêter ou redémarrer le serveur
  <productname>PostgreSQL</productname></refpurpose>
 </refnamediv>

 <refsynopsisdiv>
  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">start</arg>
   <arg>-w</arg>
   <arg>-t <replaceable>secondes</replaceable></arg>
   <arg>-s</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <arg>-l <replaceable>nomfichier</replaceable></arg>
   <arg>-o <replaceable>options</replaceable></arg>
   <arg>-p <replaceable>chemin</replaceable></arg>
   <arg>-c</arg>
   <sbr/>
   <command>pg_ctl</command>
   <arg choice="plain">stop</arg>
   <arg>-W</arg>
   <arg>-t <replaceable>secondes</replaceable></arg>
   <arg>-s</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <arg>-m
     <group choice="plain">
       <arg>s[mart]</arg>
       <arg>f[ast]</arg>
       <arg>i[mmediate]</arg>
     </group>
   </arg>
   <sbr/>
   <command>pg_ctl</command>
   <arg choice="plain">restart</arg>
   <arg>-w</arg>
   <arg>-t <replaceable>secondes</replaceable></arg>
   <arg>-s</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <arg>-c</arg>
   <arg>-m
     <group choice="plain">
       <arg>s[mart]</arg>
       <arg>f[ast]</arg>
       <arg>i[mmediate]</arg>
     </group>
   </arg>
   <arg>-o <replaceable>options</replaceable></arg>
   <sbr/>
   <command>pg_ctl</command>
   <arg choice="plain">reload</arg>
   <arg>-s</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <sbr/>
   <command>pg_ctl</command>
   <arg choice="plain">status</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <sbr/>
   <command>pg_ctl</command>
   <arg choice="plain">kill</arg>
   <arg choice="plain"><replaceable>nom_signal</replaceable></arg>
   <arg choice="plain"><replaceable>id_processus</replaceable></arg>
   <sbr/>
   <command>pg_ctl</command>
   <arg choice="plain">register</arg>
   <arg>-N <replaceable>nom_service</replaceable></arg>
   <arg>-U <replaceable>nom_utilisateur</replaceable></arg>
   <arg>-P <replaceable>mot_de_passe</replaceable></arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <arg>-w</arg>
   <arg>-t <replaceable>secondes</replaceable></arg>
   <arg>-s</arg>
   <arg>-o <replaceable>options</replaceable></arg>
   <sbr/>

   <command>pg_ctl</command>
   <arg choice="plain">unregister</arg>
   <arg>-N <replaceable>nom_service</replaceable></arg>
  </cmdsynopsis>
 </refsynopsisdiv>

 <refsect1 id="app-pg-ctl-description">
  <title>Description</title>
  <indexterm zone="app-pg-ctl">
   <primary>pg_ctl</primary>
  </indexterm>

  <para>
   <application>pg_ctl</application> est un outil de démarrage, d'arrêt et de
   redémarrage du serveur <productname>PostgreSQL</productname>
   (<xref linkend="app-postgres"/>). Il permet également d'afficher le
   statut d'un serveur
   en cours d'exécution. Bien que le serveur puisse être démarré manuellement,
   <application>pg_ctl</application> encapsule les tâches comme la redirection
   des traces ou le détachement du terminal et du groupe de processus. Il fournit
   également des options intéressantes pour l'arrêt contrôlé.
  </para>

  <para>
   Dans le mode <option>start</option>, un nouveau serveur est démarré. Le
   serveur est démarré en tâche de fond et l'entrée standard est attachée à
   <filename>/dev/null</filename>. La sortie standard et la sortie d'erreurs
   standard sont soit envoyées dans un journal de traces (si l'option
   <option>-l</option> est utilisée) soit redirigées vers la sortie standard de
   <application>pg_ctl</application> (et non pas la sortie d'erreurs standard).
   Si aucun journal de traces n'est précisé, la sortie standard de
   <application>pg_ctl</application> devrait être redirigée vers un fichier ou
   envoyée via un tube à un autre processus, par exemple un programme de
   rotation des journaux, comme <application>rotatelogs</application>&nbsp;;
   dans le cas contraire <command>postgres</command> écrit sa sortie sur
   le terminal de contrôle (à partir de l'arrière-plan) et ne se détache pas du groupe de
   processus du shell.
  </para>

  <para>
   Dans le mode <option>stop</option>, le serveur en cours d'exécution dans le
   répertoire spécifié est arrêté. Trois méthodes différentes d'arrêt peuvent
   être choisies avec l'option <option>-m</option>&nbsp;: le mode
   <quote>Smart</quote> attend la déconnexion de tous les clients. C'est la
   valeur par défaut. Le mode <quote>Fast</quote> n'attend pas la déconnexion
   des clients. Toutes les transactions actives sont annulées et les clients
   sont contraints de se déconnecter. Le serveur est ensuite arrêté. Le mode
   <quote>Immediate</quote> tue tous les processus serveurs sans leur laisser
   la possibilité de faire un arrêt propre. 
   Cela conduit à une tentative de récupération au redémarrage.
  </para>

  <para>
   Le mode <option>restart</option> exécute en fait un arrêt suivi d'un
   démarrage. Ceci permet de modifier les options en ligne de commande de
   <command>postgres</command>.
  </para>

  <para>
   Le mode <option>reload</option> envoie simplement au processus
   <command>postgres</command> un signal <systemitem>SIGHUP</systemitem>. Le
   processus relit alors ses fichiers de configuration
   (<filename>postgresql.conf</filename>, <filename>pg_hba.conf</filename>, etc.).
   Cela permet de modifier les options des fichiers de configuration sans
   qu'il soit nécessaire d'effectuer un redémarrage complet pour que les
   modifications soient prises en compte.
  </para>

  <para>
   Le mode <option>status</option> vérifie si un serveur est toujours en cours
   d'exécution sur le répertoire de données spécifié. Si c'est le cas, le
   <acronym>PID</acronym> et les options en ligne de commande utilisées lors de
   son démarrage sont affichés.
  </para>

  <para>
   Le mode <option>kill</option> permet d'envoyer un signal à un processus
   spécifique. Ceci est particulièrement utile pour
   <productname>Microsoft Windows</productname>, qui ne possède pas de commande
   <application>kill</application>. <literal>--help</literal> permet d'afficher
   la liste des noms de signaux supportés.
  </para>

  <para>
   Le mode <option>register</option> permet d'enregistrer un service
   système sur <productname>Microsoft Windows</productname>.
  </para>

  <para>
   Le mode <option>unregister</option> permet, sur
   <productname>Microsoft Windows</productname>, d'annuler un service système
   précédemment enregistré avec la commande <option>register</option>.
  </para>
 </refsect1>

 <refsect1 id="app-pg-ctl-options">
  <title>Options</title>

    <variablelist>

     <varlistentry>
      <term><option>-c</option></term>
      <listitem>
       <para>
        Tente d'autoriser la création de fichiers core suite à un arrêt brutal
	du serveur, sur les plateformes où cette fonctionnalité est disponible,
	en augmentant la limite logicielle qui en dépend. C'est utile pour le
	déboguage et pour diagnostiquer des problèmes en permettant la
	récupération d'une trace de la pile d'un processus serveur en échec.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-D <replaceable class="parameter">répertoire_données</replaceable></option></term>
      <listitem>
       <para>
	Indique l'emplacement des fichiers de la base de données sur le
	système de fichiers. Si cette option est omise, la variable d'environnement
	<envar>PGDATA</envar> est utilisée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-l <replaceable class="parameter">nomfichier</replaceable></option></term>
      <listitem>
       <para>
	Ajoute la sortie des traces du serveur dans
	<replaceable>nomfichier</replaceable>. Si le fichier n'existe pas, il
	est créé. L'<systemitem>umask</systemitem> est configuré à 077, donc l'accès au
	journal des traces est, par défaut, interdit aux autres utilisateurs.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-m <replaceable class="parameter">mode</replaceable></option></term>
      <listitem>
       <para>
	Précise le mode d'arrêt. <replaceable>mode</replaceable> est
	<literal>smart</literal>, <literal>fast</literal> ou
	<literal>immediate</literal>, ou encore la première lettre d'un de ceux-là.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-o <replaceable class="parameter">options</replaceable></option></term>
      <listitem>
       <para>
        Indique les options à passer directement à la commande
        <command>postgres</command>.
       </para>
       <para>
       
	Les options sont habituellement entourées par des guillemets simples
	ou doubles pour être sûr qu'elles soient passées groupées.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-p <replaceable class="parameter">chemin</replaceable></option></term>
      <listitem>
       <para>
	Indique l'emplacement de l'exécutable <filename>postgres</filename>.
	Par défaut, l'exécutable <filename>postgres</filename> est pris à
	partir du même répertoire que <command>pg_ctl</command> ou, si cela
	échoue, à partir du répertoire d'installation codé en dur. Il n'est pas
	nécessaire d'utiliser cette option sauf cas inhabituel, comme lorsque des erreurs
	concernant l'impossibilité de trouver l'exécutable <filename>postgres</filename>
	apparaissent.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-s</option></term>
      <listitem>
       <para>
        Affichage des seules erreurs, pas de messages d'information.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-t</option></term>
      <listitem>
       <para>
        Le nombre de secondes à attendre pour la fin du lancement ou de l'arrêt.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-w</option></term>
      <listitem>
       <para>
	Attendre la fin du démarrage ou de l'arrêt. Le temps d'attente par
	défaut est de 60
	secondes. C'est la valeur par défaut pour les arrêts. Un arrêt réussi
	est indiqué par la suppression du fichier <acronym>PID</acronym>.
	Pour le démarrage, un <command>psql -l</command> se terminant avec
	succès indique que tout va bien. <command>pg_ctl</command> tente
	d'utiliser le bon port pour <application>psql</application>. Si la variable
	d'environnement <envar>PGPORT</envar> existe, elle est utilisée. Sinon,
	un port configuré dans le fichier <filename>postgresql.conf</filename> est
	cherché. Si aucun des deux n'est utilisé,
	le port par défaut avec lequel
	<productname>PostgreSQL</productname> a été compilé (5432 par défaut) est
	utilisé.
	Lorsqu'il attend, <command>pg_ctl</command> renvoie un code de sortie
	précis fondé sur le succès du démarrage ou de l'arrêt.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-W</option></term>
      <listitem>
       <para>
	Ne pas attendre la fin du démarrage ou de l'arrêt. C'est la
	valeur par défaut pour les démarrages et redémarrages.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>

 <refsect2 id="app-pg-ctl-windows-options">
   <title>Options Windows</title>

   <variablelist>
       <varlistentry>
         <term><option>-N <replaceable class="parameter">nom_service</replaceable></option></term>
         <listitem>
           <para>
             Nom du service système à enregistrer. Le nom est utilisé à la fois
	     comme nom de service et comme nom affiché.
           </para>
         </listitem>
       </varlistentry>

       <varlistentry>
         <term><option>-P <replaceable class="parameter">mot_de_passe</replaceable></option></term>
         <listitem>
           <para>
             Mot de passe de l'utilisateur qui démarre le service.
           </para>
         </listitem>
       </varlistentry>

       <varlistentry>
         <term><option>-U <replaceable class="parameter">nom_utilisateur</replaceable></option></term>
         <listitem>
           <para>
             Nom de l'utilisateur qui démarre le service. Pour les utilisateurs
	     identifiés sur un domaine, on utilise le format
	     <literal>DOMAIN\nom_utilisateur</literal>.
           </para>
         </listitem>
        </varlistentry>
   </variablelist>
 </refsect2>

 </refsect1>


 <refsect1>
  <title>Environnement</title>

  <variablelist>
   <varlistentry>
    <term><envar>PGDATA</envar></term>

    <listitem>
     <para>
      Emplacement par défaut du répertoire des données.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><envar>PGPORT</envar></term>

    <listitem>
     <para>
      Port par défaut pour <xref linkend="app-psql"/> (utilisé par l'option -w).
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Pour les autres paramètres serveur, voir <xref linkend="app-postgres"/>.
   Cet outil, comme la plupart des autres outils <productname>PostgreSQL</productname>,
   utilise aussi les variables d'environnement supportées par la bibliothèque
   <application>libpq</application> (voir <xref linkend="libpq-envars"/>).
  </para>
 </refsect1>


 <refsect1>
  <title>Fichiers</title>

  <variablelist>
   <varlistentry>
    <term><filename>postmaster.pid</filename></term>

    <listitem>
     <para>
      Ce fichier, situé dans le répertoire des données, est utilisé pour
      aider <application>pg_ctl</application> à déterminer si le serveur est
      actuellement en cours d'exécution.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><filename>postmaster.opts.default</filename></term>

    <listitem>
     <para>
      Si ce fichier existe dans le répertoire des données,
      <application>pg_ctl</application> (dans le mode <option>start</option>)
      passe le contenu du fichier comme options de la commande
      <command>postgres</command>, sauf en cas de surcharge par l'option
      <option>-o</option>.
      <!-- Je n'ai pas cette phrase dans la VO...
	  Le contenu de ce fichier est aussi affiché en mode <option>status</option>
	  -->
	  </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><filename>postmaster.opts</filename></term>

    <listitem>
     <para>Si ce fichier existe dans le répertoire des données,
      <application>pg_ctl</application> (en mode <option>restart</option>)
      passe le contenu du fichier comme options de
      <application>postgres</application>, sauf en cas de surcharge par
      l'option <option>-o</option>.
      <!-- Elle apparaît ici, en fait... 
	  Le contenu de ce fichier est aussi affiché en mode <option>status</option>.
	  -->
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><filename>postgresql.conf</filename></term>

    <listitem>
     <para>
      Ce fichier, situé dans le répertoire des données, est analysé pour
      trouver le port à utiliser avec <application>psql</application>
      lorsque <option>-w</option> est donné en mode <option>start</option>.
     </para>
    </listitem>
   </varlistentry>

  </variablelist>
 </refsect1>


 <refsect1>
  <title>Notes</title>

  <para>
   Attendre le démarrage complet n'est pas une opération bien définie et
   peut échouer si le contrôle d'accès est configuré pour qu'un client
   local ne puisse pas se connecter sans interaction manuelle (par exemple, une
   authentification par mot de passe). Pour des variables de connexion
   supplémentaires, voir <xref linkend="libpq-envars"/>. Pour les mots de passe,
   voir aussi <xref linkend="libpq-pgpass"/>.
  </para>
 </refsect1>


 <refsect1 id="r1-app-pgctl-2">
  <title>Exemples</title>

  <refsect2 id="r2-app-pgctl-3">
   <title>Lancer le serveur</title>

   <para>
    Démarrer un serveur&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl start</userinput>
</screen>
   </para>

   <para>
    Démarrer un serveur, avec blocage tant que le serveur n'est pas
    complètement démarré&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl -w start</userinput>
</screen>
   </para>

   <para>
    Pour un serveur utilisant le port 5433 et s'exécutant sans
    <function>fsync</function>, on utilise&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl -o "-F -p 5433" start</userinput>
</screen>
   </para>
  </refsect2>

  <refsect2 id="r2-app-pgctl-4">
   <title>Arrêt du serveur</title>
   <para>
<screen><prompt>$</prompt> <userinput>pg_ctl stop</userinput>
</screen>
    arrête le serveur. Utiliser l'option <option>-m</option> permet de
    contrôler <emphasis>comment</emphasis> le serveur s'arrête.
   </para>
  </refsect2>

  <refsect2 id="r2-app-pgctl-5">
   <title>Redémarrage du serveur</title>

   <para>
    Redémarrer le serveur est pratiquement équivalent à l'arrêter puis à le
    démarrer à nouveau si ce n'est que <command>pg_ctl</command> sauvegarde et
    réutilise les options en ligne de commande qui étaient passées à
    l'instance précédente. Pour redémarrer le serveur de la façon la plus simple,
    on utilise&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl restart</userinput>
</screen>
   </para>

   <para>
    Redémarrer le serveur, en attendant l'arrêt et le redémarrage&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl -w restart</userinput>
</screen>
   </para>

   <para>
    Redémarrer en utilisant le port 5433 et en désactivant
    <function>fsync</function> après redémarrage&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl -o "-F -p 5433" restart</userinput>
</screen>
   </para>
  </refsect2>

  <refsect2 id="r2-app-pgctl-6">
   <title>Affichage de l'état du serveur</title>

   <para>
    Voici un exemple de statut affiché à partir de
    <application>pg_ctl</application>&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl status</userinput>
<computeroutput>
pg_ctl: server is running (pid: 13718)
Command line was:
/usr/local/pgsql/bin/postgres '-D' '/usr/local/pgsql/data' '-p' '5433' '-B' '128'</computeroutput></screen>
    C'est la ligne de commande qui sera appelée en mode redémarrage.
   </para>
  </refsect2>
 </refsect1>


 <refsect1>
  <title>Voir aussi</title>

  <para>
   <xref linkend="app-postgres"/>
  </para>
 </refsect1>

</refentry>
