<!--
$Header: /var/lib/cvs/pgsql-fr/sgml/ref/pg_dump.sgml,v 1.13 2005/09/15 07:03:27 guillaume Exp $
PostgreSQL documentation
-->

<refentry id="APP-PGDUMP">
 <refmeta>
  <refentrytitle>pg_dump</refentrytitle>
  <manvolnum>1</manvolnum>
  <refmiscinfo>Application</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>pg_dump</refname>

  <refpurpose>
   sauvegarde une base de données <productname>PostgreSQL</productname> dans un
   script ou un autre fichier d'archive
  </refpurpose>
 </refnamediv>

 <indexterm zone="app-pgdump">
  <primary>pg_dump</primary>
 </indexterm>

 <refsynopsisdiv>
  <cmdsynopsis>
   <command>pg_dump</command>
   <arg rep="repeat"><replaceable>option</replaceable></arg>
   <arg><replaceable>nom_base</replaceable></arg>
  </cmdsynopsis>
 </refsynopsisdiv>


 <refsect1 id="pg-dump-description">
  <title>
   Description
  </title>

  <para>
   <application>pg_dump</application> est un utilitaire pour sauvegarder une base de
   données <productname>PostgreSQL</productname>. Il réalise des sauvegardes 
   consistantes même si la base de données est en cours d'utilisation concurrente.
   <application>pg_dump</application> ne bloque pas l'accès des autres
   utilisateurs (ni en lecture ni en écriture).
  </para>

  <para>
   Les sauvegardes peuvent être sous forme de script ou de fichier d'archive.
   Les sauvegardes script sont au format texte et contiennent les commandes SQL
   requises pour reconstruire la base de données dans l'état où elle était au
   moment de la sauvegarde. Pour restaurer à partir de ces scripts, utilisez <xref
   linkend="app-psql">. Ils peuvent être utilisés pour reconstruire la base de
   données y compris sur d'autres machines et d'autres architectures, et même avec
   quelques modifications, sur d'autres produits de bases de données SQL.
  </para>

  <para>
   Les autres formats de fichiers d'archive doivent être utilisés avec
   <xref linkend="app-pgrestore"> pour reconstruire la base de données. Ils
   permettent aussi à <application>pg_restore</application> de sélectionner ce
   qui doit être restauré ou même de réordonner les éléments avant qu'ils ne
   soient restaurés. Les fichiers d'archive sont aussi conçus pour être
   portables suivant les architectures.
  </para>

  <para>
   Lorsqu'il est utilisé avec un des formats de fichier d'archive et combiné
   avec <application>pg_restore</application>,
   <application>pg_dump</application> fournit un mécanisme flexible d'archivage
   et de transfert. <application>pg_dump</application> peut être utilisé pour
   sauvegarder une base de données entière, puis
   <application>pg_restore</application> peut être utilisé pour examiner
   l'archive et/ou sélectionner quelles parties de la base de données seront
   restaurées. Le format de fichier en sortie le plus flexible est le format
   <quote>personnalisé</quote> (<option>-Fc</option>). Il permet la sélection et
   le réordonnancement de tous les éléments archivés et est compressé par
   défaut. Le format <application>tar</application> (<option>-Ft</option>) n'est
   pas compressé et il n'est pas possible de réordonner les données au
   chargement mais est assez flexible&nbsp;; de plus, il est manipulable
   avec d'autres outils Unix standard comme <command>tar</command>.
  </para>

  <para>
   Lorsque <application>pg_dump</application> est en cours d'exécution, il
   il faudrait examiner la sortie à la recherche de tout message d'avertissement 
   (affiché sur la sortie standard des erreurs), spécialement à la lumière
   des limitations indiquées ci-dessous.
  </para>

 </refsect1>

 <refsect1 id="pg-dump-options">
  <title>Options</title>

  <para>
   Les options suivantes en ligne de commande contrôlent le contenu et le
   format de sortie.

    <variablelist>
     <varlistentry>
      <term><replaceable class="parameter">nom_base</replaceable></term>
      <listitem>
       <para>
	Spécifie le nom de la base de données à sauvegarder. Si elle n'est pas
	spécifiée, la variable d'environnement <envar>PGDATABASE</envar> est
	utilisée. Dans le cas contraire, le nom de l'utilisateur spécifié pour
	la connexion est utilisé.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-a</></term>
      <term><option>--data-only</></term>
      <listitem>
       <para>
	Sauvegarde seulement les données, pas le schéma (définition des
	données).
       </para>

       <para>
        Cette option est seulement intéressante pour le format texte.
	Pour les formats d'archive, vous devez spécifier l'option a 
        l'appel de <command>pg_restore</command>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-c</option></term>
      <term><option>--clean</option></term>
      <listitem>
       <para>
        Ajoute les commandes pour nettoyer (supprimer) les objets de la base
        avant (les commandes pour) les créer.
       </para>

       <para>
        Cette option est seulement intéressante pour le format texte. Pour les
	formats d'archive, vous devez spécifier l'option à l'appel de
	<command>pg_restore</command>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-C</></term>
      <term><option>--create</></term>
      <listitem>
       <para>
        Commence la sortie avec une commande de création de la base de données
	elle-même et de reconnexion à la nouvelle base de données. (Avec un
	script de cette forme, peu importe la base de données à laquelle vous
	vous connectez avant de lancer le script.)
       </para>

       <para>
        Cette option est seulement intéressante pour le format texte. Pour les
	formats d'archive, vous devez spécifier l'option à l'appel de
	<command>pg_restore</command>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-d</option></term>
      <term><option>--inserts</option></term>
      <listitem>
       <para>
	Sauvegarde les données avec des commandes <command>INSERT</command>
	(plutôt qu'une commande <command>COPY</command>). Ceci ralentit la
	restauration&nbsp;; c'est principalement utile pour créer des
	sauvegardes qui seront chargées dans des bases de données autres que
	<productname>PostgreSQL</productname>. Notez que la restauration
	pourrait échouer si vous avez réordonné l'ordre des colonnes. L'option
	<option>-D</option> est plus sûre, bien qu'encore plus lente.

       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-D</option></term>
      <term><option>--column-inserts</option></term>
      <term><option>--attribute-inserts</option></term>
      <listitem>
       <para>
	Sauvegarde les données avec des commandes <command>INSERT</command> et
	des noms de colonnes explicites (<literal>INSERT INTO
	<replaceable>table</replaceable> (<replaceable>colonne</replaceable>,
	...) VALUES ...</literal>). Ceci ralentit de beaucoup la
	restauration&nbsp;; c'est principalement utile pour créer des
	sauvegardes qui seront chargées dans des bases de données autres que
	<productname>PostgreSQL</productname>..
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-f <replaceable class="parameter">file</replaceable></option></term>
      <term><option>--file=<replaceable class="parameter">file</replaceable></option></term>
      <listitem>
       <para>
	Envoie la sortie dans le fichier spécifié. Si ceci est omis, la sortie
	standard est utilisée.
       </para>
      </listitem>
     </varlistentry>

	 <varlistentry>
	  <term><option>-E <replaceable class="parameter">codage</replaceable></option></term>
	  <term><option>--encoding=<replaceable class="parameter">codage</replaceable></option></term>
	  <listitem>
	   <para>
	    Crée la sauvegarde dans le codage de l'ensemble de caractères
	    spécifié. Par défaut, la sauvegarde utilise le codage par défaut
	    de la base de données (une autre façon d'obtenir le même résultat
	    est de configurer la variable d'environnement
	    <envar>PGCLIENTENCODING</envar> avec le codage désiré pour la
	    sauvegarde).
	   </para>
	  </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-F <replaceable class="parameter">format</replaceable></option></term>
      <term><option>--format=<replaceable class="parameter">format</replaceable></option></term>
      <listitem>
       <para>
        Sélectionne le format de la sortie.
	<replaceable>format</replaceable> correspond à un des éléments
	suivants&nbsp;:

       <variablelist>
        <varlistentry>
         <term><literal>p</></term>
         <listitem>
          <para>
           Crée un fichier de scripts <acronym>SQL</acronym> en texte simple
	   (par défaut).
          </para>
         </listitem>
        </varlistentry>

        <varlistentry>
         <term><literal>t</></term>
         <listitem>
          <para>
         Crée une archive <command>tar</command> utilisable par 
         <application>pg_restore</application>. Utiliser ce format d'archives
	 permet le réordonnancement et/ou l'exclusion d'objets de la base lors
	 de la restauration de la base de données. Il est aussi possible de
	 sélectionner les données rechargées au moment de la restauration.
          </para>
         </listitem>
        </varlistentry>

        <varlistentry>
         <term><literal>c</></term>
         <listitem>
          <para>
         Crée une archive personnalisée convenable pour
	 <application>pg_restore</application>. C'est le format le plus
	 flexible dans le fait qu'il permet le réordonnancement du chargement des
	 données ainsi que la définition des objets. Ce format est aussi compressé
	 par défaut.
          </para>
         </listitem>
        </varlistentry>

       </variablelist>
       </para>

      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-i</></term>
      <term><option>--ignore-version</></term>
      <listitem>
       <para>
        Ignore les différences de version entre
        <application>pg_dump</application> et le serveur de bases de données.
       </para>

       <para>
        <application>pg_dump</application> peut gérer des bases de données à
	partir des versions précédentes de <productname>PostgreSQL</> mais les
	très anciennes versions ne sont plus supportées (actuellement celles
	précédant la 7.0). Utilisez cette option si vous avez besoin de ne pas
	vérifier la version (et si <application>pg_dump</application> échoue à
	ce moment, ne prétendez pas que vous n'avez pas été prévenu).
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-n <replaceable class="parameter">schéma</replaceable></option></term>
      <term><option>--schema=<replaceable class="parameter">schema</replaceable></option></term>
      <listitem>
       <para>
        Sauvegarde seulement le contenu de <replaceable
	class="parameter">schema</>. Si cette option n'est pas spécifiée, tous
	les schémas non système de la base de données cible sont sauvegardés.
       </para>

       <note>
        <para>
         Dans ce mode, <application>pg_dump</application> ne tente pas de
	 sauvegarder tous les objets de la base de données qui ne font
	 pas partie du schéma sélectionné. Du coup, il n'y a pas de garantie que
	 la sauvegarde d'un seul schéma puisse être restaurée avec succès
	dans une base de données propre.
        </para>
       </note>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-o</></term>
      <term><option>--oids</></term>
      <listitem>
       <para>
	Sauvegarde les identifiants d'objets (<acronym>OID</acronym>) comme
	faisant parti des données de chaque table. Utilisez cette option si
	votre application référence les colonnes <acronym>OID</> 
	(par exemple dans une contrainte de clé étrangère). Sinon, cette
	option ne devrait pas être utilisée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-O</></term>
      <term><option>--no-owner</option></term>
      <listitem>
       <para>
        N'affiche pas les commandes d'initialisation du propriétaire des
	objets pour correspondre à la base de données originale. Par défaut,
	<application>pg_dump</application> lance des instructions <command>ALTER
	OWNER</command> ou <command>SET SESSION AUTHORIZATION</command> pour
	initialiser le propriétaire des objets de la base de données.
	Ces instructions échouent lorsque le script n'est pas
	lancé par un superutilisateur (ou par l'utilisateur
	qui possède tous les objets de ce script). Pour créer un script qui peut
	restaurer tous les utilisateurs et remplace le propriétaire de tous
	les objets, spécifiez <option>-O</>.
       </para>

       <para>
        Cette option est seulement utile pour le format texte. Pour les
	formats d'archive, vous devez spécifier l'option à l'appel de
	<command>pg_restore</command>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-R</option></term>
      <term><option>--no-reconnect</option></term>
      <listitem>
       <para>
        Cette option est obsolète mais est toujours acceptée pour des raisons
	de compatibilité ascendante.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-s</option></term>
      <term><option>--schema-only</option></term>
      <listitem>
       <para>
	Sauvegarde uniquement la définition des objets (le schéma), pas les
	données.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-S <replaceable
	class="parameter">nomutilisateur</replaceable></option></term>
      <term><option>--superuser=<replaceable
	class="parameter">nomutilisateur</replaceable></option></term>
      <listitem>
       <para>
        Spécifie le nom du superutilisateur à utiliser lors de la désactivation
	des déclencheurs. Ceci est seulement utile si
	<option>--disable-triggers</> est utilisé. (Habituellement, il est
	mieux ne pas utiliser ceci et de lancer le script en tant que ce
	superutilisateur.)
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-t <replaceable class="parameter">table</replaceable></option></term>
      <term><option>--table=<replaceable class="parameter">table</replaceable></option></term>
      <listitem>
       <para>
	Sauvegarde uniquement les données de <replaceable
	class="parameter">table</replaceable>. Il est possible d'avoir
	plusieurs tables avec le même nom dans différents schémas&nbsp;; si
	c'est le cas, toutes les tables correspondantes sont
	sauvegardées. Spécifiez à la fois <option>--schema</> et
	<option>--table</> pour sélectionner seulement une table.
       </para>

       <note>
        <para>
         Dans ce mode, <application>pg_dump</application> ne fait aucune
	 tentative de sauvegarde des autres objets de la base de données dont la
	 table sélectionnée pourrait dépendre. Du coup, il n'existe aucune
	 garantie que cette sauvegarde d'une seule table pourra être restaurée
	 toute seule dans une base de données propre.
        </para>
       </note>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-v</></term>
      <term><option>--verbose</></term>
      <listitem>
       <para>
	Spécifie le mode verbeux. Ceci fait que
	<application>pg_dump</application> affiche des commentaires détaillés
	sur les objets et les heures de début et de fin pour le fichier de
	sauvegarde, ainsi que des messages de progression sur la sortie standard
	des erreurs.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-x</></term>
      <term><option>--no-privileges</></term>
      <term><option>--no-acl</></term>
      <listitem>
       <para>
	Empêche la sauvegarde des droits d'accès (commandes grant/revoke).
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-X disable-dollar-quoting</></term>
      <term><option>--disable-dollar-quoting</></term>
      <listitem>
       <para>
	Cette option désactive l'utilisation des guillemets dollar pour les
	corps des fonctions et les force à être entre guillemets en utilisant
	la syntaxe standard des chaînes dans SQL.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-X disable-triggers</></term>
      <term><option>--disable-triggers</></term>
      <listitem>
       <para>
        Cette option est seulement utile pour créer une sauvegarde des données
	seules. Elle demande à <application>pg_dump</application> d'inclure des
	commandes pour désactiver temporairement les déclencheurs sur les tables
	cibles pendant que les données sont en cours de chargement. Utilisez
	ceci si vous avez des vérifications d'intégrité ou d'autres déclencheurs
	sur les tables, déclencheurs que vous ne souhaitez pas exécuter pendant
	le chargement des données.
       </para>

       <para>
        Actuellement, les commandes émises pour <option>--disable-triggers</>
	doivent être lancées par le superutilisateur. Donc, vous devez aussi
	spécifier le nom du superutilisateur avec <option>-S</> ou, de
	préférence, faire attention à lancer le script résultant en tant que
	superutilisateur.
       </para>

       <para>
        Cette option est seulement utile pour le format texte. Pour les
	formats d'archive, vous devez spécifier l'option à l'appel de
	<command>pg_restore</command>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-X use-set-session-authorization</></term>
      <term><option>--use-set-session-authorization</></term>
      <listitem>
       <para>
	Affiche les commandes <command>SET SESSION AUTHORIZATION</> du standard
	SQL au lieu des commandes <command>ALTER OWNER</> pour déterminer le
	propriétaire de l'objet. Ceci rend la sauvegarde encore plus compatible
	avec le standard mais, suivant l'historique des objets dans la sauvegarde,
	pourrait ne pas restaurer correctement. De plus, une sauvegarde utilisant
	<command>SET SESSION AUTHORIZATION</> demandera certainement les droits
	d'un superutilisateur pour se restaurer correctement alors que
	<command>ALTER OWNER</> requiert moins de droits.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-Z <replaceable class="parameter">0..9</replaceable></option></term>
      <term><option>--compress=<replaceable class="parameter">0..9</replaceable></option></term>
      <listitem>
       <para>
	Spécifie le niveau de compression à utiliser dans les formats d'archive
	qui supportent la compression. (Actuellement, seul le format d'archive
	personnalisée supporte la compression.)
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </para>

   <para>
    <application>pg_dump</application> accepte aussi les arguments suivants
    comme paramètres de connexion&nbsp;:

    <variablelist>
     <varlistentry>
      <term><option>-h <replaceable
	class="parameter">hôte</replaceable></></term>
      <term><option>--host <replaceable
	class="parameter">hôte</replaceable></></term>
      <listitem>
       <para>
        Indique le nom d'hôte de la machine sur laquelle le serveur de bases
        de données est exécuté. Si la valeur commence par une barre oblique (/),
        elle est utilisée comme répertoire pour le socket de domaine Unix.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-p <replaceable
	class="parameter">port</replaceable></></term>
      <term><option>--port <replaceable
	class="parameter">port</replaceable></></term>
      <listitem>
       <para>
        Indique le port TCP ou le fichier local de socket de domaine Unix
        sur lequel le serveur écoute pour la connexion.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-U <replaceable
	class="parameter">nomutilisateur</replaceable></></term>
      <term><option>--username <replaceable
	class="parameter">nomutilisateur</replaceable></></term>
      <listitem>
       <para>
        Nom d'utilisateur à utiliser pour se connecter.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-W</></term>
      <term><option>--password</></term>
      <listitem>
       <para>
        Force la demande d'un mot de passe.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </para>
 </refsect1>

 <refsect1>
  <title>Environnement</title>

  <variablelist>
   <varlistentry>
    <term><envar>PGDATABASE</envar></term>
    <term><envar>PGHOST</envar></term>
    <term><envar>PGPORT</envar></term>
    <term><envar>PGUSER</envar></term>

    <listitem>
     <para>
      Paramètres de connexion par défaut.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </refsect1>

 <refsect1 id="app-pgdump-diagnostics">
  <title>Diagnostiques</title>

  <para>
   <application>pg_dump</application> exécute en interne des instructions
   <command>SELECT</command>. Si vous avez des problèmes en lançant
   <application>pg_dump</application>, assurez-vous d'être capable de
   sélectionner des informations de la base de données en utilisant, par
   exemple, <xref linkend="app-psql">.
  </para>
 </refsect1>


 <refsect1 id="pg-dump-notes">
  <title>Notes</title>

  <para>
   Si votre groupe de bases de données a des ajouts supplémentaires dans la
   base de données <literal>template1</>, faites attention à restaurer la sortie
   de <application>pg_dump</application> dans une base de données réellement
   vide&nbsp;; sinon vous obtiendrez certainement des erreurs dûes à la
   définition dupliquée des objets ajoutés. Pour faire qu'une base de données
   soit vide et sans ajout local, copiez à partir de <literal>template0</>, et
   non pas à partir de <literal>template1</>, par exemple&nbsp;:
<programlisting>
CREATE DATABASE foo WITH TEMPLATE template0;
</programlisting>
  </para>

  <para>
   <application>pg_dump</application> a quelques limitations&nbsp;:

   <itemizedlist>
    <listitem>
     <para>
      Lorsqu'une sauvegarde des données seules est choisie et que l'option
      <option>--disable-triggers</> est utilisée,
      <application>pg_dump</application> émet des commandes pour désactiver les
      déclencheurs sur les tables utilisateur avant d'insérer les données et des
      commandes pour les réactiver après que les données sont insérées. Si la
      restauration est stoppée en plein milieu, les catalogues système
      pourraient être laissés dans le mauvais état.
     </para>
    </listitem>

   </itemizedlist>
  </para>

  <para>
   Les membres des archives tar sont limités à une taille inférieure à
   8&nbsp;Go. (Ceci est une limitation inhérente au format des fichiers tar.) Du
   coup, ce format ne peut pas être utilisé si la représentation textuelle
   d'une table dépasse cette taille. La taille totale d'une archive tar et de
   tout autre format de sortie n'est pas limitée, sauf peut-être par le système
   d'exploitation.
  </para>

  <para>
   Le fichier de sauvegarde produit par <application>pg_dump</application> ne
   contient pas les statistiques utilisées par l'optimiseur pour prendre les
   décisions de planification des requêtes. Du coup, il est conseillé de lancer
   <command>ANALYZE</> après avoir restauré une sauvegarde pour s'assurer de
   bonnes performances.
  </para>

 </refsect1>

 <refsect1 id="pg-dump-examples">
  <title>Exemples</title>

  <para>
   Pour sauvegarder une base de données&nbsp;:
<screen>
<prompt>$</prompt> <userinput>pg_dump mabase &gt; base.out</userinput>
</screen>
  </para>

  <para>
   Pour recharger cette base de données&nbsp;:
<screen>
<prompt>$</prompt> <userinput>psql -d base -f base.out</userinput>
</screen>
  </para>

  <para>
   Pour sauvegarder une base de données nommée <literal>mabase</> dans un
   fichier <filename>tar</filename>&nbsp;:

<screen>
<prompt>$</prompt> <userinput>pg_dump -Ft mabase &gt; base.tar</userinput>
</screen>
  </para>

  <para>
   Pour recharger cette sauvegarde dans une base de données existante appelée
   <literal>nouvellebase</>&nbsp;:

<screen>
<prompt>$</prompt> <userinput>pg_restore -d nouvellebase base.tar</userinput>
</screen>
  </para>

 </refsect1>

 <refsect1>
  <title>Historique</title>

  <para>
   L'outil <application>pg_dump</application> est d'abord apparu dans
   <application>Postgres95</application> version 0.02. Les formats de sortie
   non texte ont été introduits dans la version 7.1 de
   <productname>PostgreSQL</productname>.
  </para>
 </refsect1>

 <refsect1>
  <title>Voir aussi</title>

  <simplelist type="inline">
   <member><xref linkend="app-pg-dumpall"></member>
   <member><xref linkend="app-pgrestore"></member>
   <member><xref linkend="app-psql"></member>
   <member>Variables d'environnement (<xref linkend="libpq-envars">)</member>
  </simplelist>
 </refsect1>

</refentry>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:nil
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
sgml-parent-document:nil
sgml-default-dtd-file:"../reference.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:"/usr/lib/sgml/catalog"
sgml-local-ecat-files:nil
End:
-->
