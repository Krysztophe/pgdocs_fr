<?xml version="1.0" encoding="ISO-8859-15"?>
<!-- Dernière modification
     le       $Date$
     par      $Author$
     révision $Revision$ -->

<refentry id="app-pg-dumpall">
 <refmeta>
  <refentrytitle id="app-pg-dumpall-title"><application>pg_dumpall</application></refentrytitle>
  <manvolnum>1</manvolnum>
  <refmiscinfo>Application</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>pg_dumpall</refname>
  <refpurpose>extraire une grappe de bases de données
   <productname>PostgreSQL</productname> dans un fichier de script
  </refpurpose>
 </refnamediv>

 <refsynopsisdiv>
  <cmdsynopsis>
   <command>pg_dumpall</command>
   <arg rep="repeat"><replaceable>option</replaceable></arg>
  </cmdsynopsis>
 </refsynopsisdiv>

 <refsect1 id="app-pg-dumpall-description">
  <title>Description</title>
  <indexterm zone="app-pg-dumpall">
   <primary>pg_dumpall</primary>
  </indexterm>


  <para>
   <application>pg_dumpall</application> est un outil d'extraction
   (<quote>sauvegarde</quote>) de toutes les bases de données
   <productname>PostgreSQL</productname> d'une grappe vers un fichier script. Celui-ci
   contient les commandes <acronym>SQL</acronym> utilisables pour
   restaurer les bases de données avec <xref linkend="app-psql"/>. Cela est obtenu
   en appelant <xref linkend="app-pgdump"/> pour chaque base de données de la
   grappe. <application>pg_dumpall</application> sauvegarde aussi les objets
   globaux, communs à toutes les bases de données.
   (<application>pg_dump</application> ne sauvegarde pas ces objets.) Cela
   inclut aussi les informations concernant les utilisateurs et groupes des
   bases de données, ainsi que les tablespaces, and properties such as les droits d'accès s'y appliquant.
  </para>

  <para>
   Puisque <application>pg_dumpall</application> lit les tables de
   toutes les bases de données, il est préférable d'avoir les droits de
   superutilisateur de la base de données pour obtenir une sauvegarde complète.
   De plus, il faut détenir des droits superutilisateur pour exécuter le script
   produit, afin de pouvoir créer les utilisateurs, les groupes et
   les bases de données.
  </para>

  <para>
   Le script SQL est écrit sur la sortie standard. Les opérateurs shell doivent
   être utilisés pour la rediriger dans un fichier.
  </para>

  <para>
  <application>pg_dumpall</application> se connecte plusieurs fois
   au serveur <productname>PostgreSQL</productname> (une fois par base de
   données). Si l'authentification par mot de passe est utilisé, 
   un mot de passe est demandé à chaque tentative de connexion. Il est intéressant
   de disposer d'un fichier <filename>~/.pgpass</filename> dans de tels cas. Voir <xref
   linkend="libpq-pgpass"/> pour plus d'informations.
  </para>

 </refsect1>

 <refsect1>
  <title>Options</title>

   <para>
    Les options suivantes, en ligne de commande, contrôlent le contenu et le
    format de la sortie.

    <variablelist>
     <varlistentry>
      <term><option>-a</option></term>
      <term><option>--data-only</option></term>
      <listitem>
       <para>
		Seules les donnéessont sauvegardées, pas le schéma (définition des
	données).
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-c</option></term>
      <term><option>--clean</option></term>
      <listitem>
       <para>
	   Les commandes SQL de nettoyage (suppression) des bases de données
	   avant leur recréation sont incluses. Des commandes <command>DROP</command>
	   sont également ajoutées pour	les rôles et les tablespaces.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-D</option></term>
      <term><option>--column-inserts</option></term>
      <term><option>--attribute-inserts</option></term>
      <listitem>
       <para>
	   Les données sont sauvegardées sous la forme de commandes
	   <command>INSERT</command> avec les noms de colonnes explicites
	   (<literal>INSERT INTO <replaceable>table</replaceable>(<replaceable>colonne</replaceable>, ...) VALUES ...</literal>).
	   Cela ralentit considérablement la restauration&nbsp;; c'est
	principalement utile pour créer des sauvegardes qui peuvent être
	chargées dans des bases de données autres que
	<productname>PostgreSQL</productname>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-f <replaceable class="parameter">nomfichier</replaceable></option></term>
      <term><option>--file=<replaceable class="parameter">nomfichier</replaceable></option></term>
      <listitem>
       <para>
        Envoie le résultat dans le fichier indiqué. Si cette option n'est pas
	utilisée, la sortie standard est utilisée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-g</option></term>
      <term><option>--globals-only</option></term>
      <listitem>
       <para>
	   Seuls les objets globaux sont sauvegardés (rôles et tablespaces), pas
	les bases de données.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-i</option></term>
      <term><option>--ignore-version</option></term>
      <listitem>
       <para>
        A deprecated option that is now ignored.
       </para>

       <para>
        <application>pg_dumpall</application> peut gérer des bases de données
	de versions précédentes de <productname>PostgreSQL</productname>, mais les
	très anciennes versions ne sont plus supportées (avant la 7.0). Cette option
	peut être utilisée pour surcharger la vérification de la
	version (si <application>pg_dumpall</application> échoue, il ne faudra pas nier
	avoir été averti).
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-o</option></term>
      <term><option>--oids</option></term>
      <listitem>
       <para>
	Les identifiants des objets (<acronym>OID</acronym>) sont sauvegardés comme
	faisant partie des données de chaque table. Cette option est utilisée si
	l'application référence les colonnes <acronym>OID</acronym> (par
	exemple, dans une contrainte de clé étrangère). Sinon, cette option ne
	doit pas être utilisée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-O</option></term>
      <term><option>--no-owner</option></term>
      <listitem>
       <para>
        Les commandes permettant de positionner les propriétaires des objets
	à ceux de la base de données originale. Par défaut,
	<application>pg_dumpall</application> lance les instructions
	<command>ALTER OWNER</command> ou <command>SET SESSION AUTHORIZATION</command>
	pour configurer le propriétaire des éléments créés. Ces instructions
	échouent lorsque le script est lancé par un utilisateur ne disposant
	pas des droits de superutilisateur (ou ne possédant pas les droits du
	propriétaire de tous les objets compris dans ce script). Pour que ce
	qui devient alors propriétaire de tous les objets créés, l'option
	<option>-O</option> doit être utilisée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--lock-wait-timeout=<replaceable class="parameter">timeout</replaceable></option></term>
      <listitem>
       <para>
        Do not wait forever to acquire shared table locks at the beginning of
        the dump. Instead fail if unable to lock a table within the specified
        <replaceable class="parameter">timeout</>. The timeout may be
        specified in any of the formats accepted by <command>SET
        statement_timeout</>.  (Allowed values vary depending on the server
        version you are dumping from, but an integer number of milliseconds
        is accepted by all versions since 7.3.  This option is ignored when
        dumping from a pre-7.3 server.)
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--no-tablespaces</option></term>
      <listitem>
       <para>
        Do not output commands to create tablespaces nor select tablespaces
        for objects.
        With this option, all objects will be created in whichever
        tablespace is the default during restore.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-r</option></term>
      <term><option>--roles-only</option></term>
      <listitem>
       <para>
        Sauvegarde seulement les rôles, pas les bases ni les tablespaces.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-s</option></term>
      <term><option>--schema-only</option></term>
      <listitem>
       <para>
	   Seules les définitions des objets (schéma), sans les données, sont sauvegardées.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-S <replaceable class="parameter">username</replaceable></option></term>
      <term><option>--superuser=<replaceable class="parameter">username</replaceable></option></term>
      <listitem>
       <para>
        Précise le nom du superutilisateur à utiliser pour la désactivation
	des déclencheurs. Cela n'a d'intérêt que lorsque 
	<option>--disable-triggers</option> est utilisé. (Il est en général préférable
	de ne pas utiliser cette option et de lancer le script résultant
	en tant que superutilisateur.)
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-t</option></term>
      <term><option>--tablespaces-only</option></term>
      <listitem>
       <para>
        Sauvegarde seulement les tablespaces, pas les bases ni les rôles.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-v</option></term>
      <term><option>--verbose</option></term>
      <listitem>
       <para>
		Indique l'utilisation du mode verbeux. Ainsi
	<application>pg_dumpall</application> affiche les heures de
	démarrage/arrêt dans le fichier de sauvegarde et les messages de
	progression sur la sortie standard. Il active également le mode verbeux
	dans <application>pg_dump</application>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-x</option></term>
      <term><option>--no-privileges</option></term>
      <term><option>--no-acl</option></term>
      <listitem>
       <para>
		Les droits d'accès (commandes grant/revoke) ne sont pas sauvegardés.
       </para>
      </listitem>
     </varlistentry>
     
     <varlistentry>
      <term><option>--binary-upgrade</option></term>
      <listitem>
       <para>
        This option is for use by in-place upgrade utilities.  Its use
        for other purposes is not recommended or supported.  The
        behavior of the option may change in future releases without
        notice.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--inserts</option></term>
      <listitem>
       <para>
        Dump data as <command>INSERT</command> commands (rather
        than <command>COPY</command>).  This will make restoration very slow;
        it is mainly useful for making dumps that can be loaded into
        non-<productname>PostgreSQL</productname> databases.  Note that
        the restore might fail altogether if you have rearranged column order.
        The <option>--column-inserts</option> option is safer, though even
        slower.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--column-inserts</option></term>
      <term><option>--attribute-inserts</option></term>
      <listitem>
       <para>
        Dump data as <command>INSERT</command> commands with explicit
        column names (<literal>INSERT INTO
        <replaceable>table</replaceable>
        (<replaceable>column</replaceable>, ...) VALUES
        ...</literal>).  This will make restoration very slow; it is mainly
        useful for making dumps that can be loaded into
        non-<productname>PostgreSQL</productname> databases.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--disable-dollar-quoting</option></term>
      <listitem>
       <para>
        L'utilisation du dollar comme guillemet dans 
	le corps des fonctions est désactivée. Celles-ci sont
	mises entre guillemets en accord avec la syntaxe du standard SQL.
       </para>
     </listitem>
    </varlistentry>

     <varlistentry>
      <term><option>--disable-triggers</option></term>
      <listitem>
       <para>
        Cette option n'est utile que lors de la création d'une sauvegarde
	des seules données. <application>pg_dumpall</application>
	inclut les commandes de désactivation temporaire des déclencheurs
	sur les tables cibles pendant le rechargement des données.
	Cette option est utile lorsqu'il existe des vérifications d'intégrité
	référentielle ou des déclencheurs sur les tables qu'on ne souhaite
	pas voir appelés lors du rechargement des données.
       </para>

       <para>
        Actuellement, les commandes émises par <option>--disable-triggers</option>
	nécessitent d'être lancées par un superutilisateur. Il est donc impératif de
	préciser le nom du superutilisateur avec <option>-S</option> ou,
	préférentiellement, de lancer le script résultant en tant que superutilisateur.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--use-set-session-authorization</option></term>
      <listitem>
       <para>
        Les commandes <command>SET SESSION AUTHORIZATION</command> du standard
	SQL sont affichées à la place des commandes <command>ALTER OWNER</command>
	pour préciser le propriétaire de l'objet. Cela améliore la compatibilité
	de la sauvegarde vis-à-vis des standard. Toutefois, du fait de l'ordre
	d'apparition des objets dans la sauvegarde, la restauration peut 
	ne pas être correcte.
       </para>
      </listitem>
     </varlistentry>

    </variablelist>
   </para>

  <para>
   Les options suivantes en ligne de commande contrôlent les paramètres de
   connexion à la base de données.

   <variablelist>
     <varlistentry>
      <term><option>-h <replaceable>hôte</replaceable></option></term>
      <term><option>--host=<replaceable>hôte</replaceable></option></term>
      <listitem>
       <para>
	Précise le nom d'hôte de la machine sur laquelle le serveur de bases de
	données est en cours d'exécution. Si la valeur commence avec un slash,
	elle est utilisée comme répertoire du socket de domaine Unix. La valeur
	par défaut est prise à partir de la variable d'environnement
	<envar>PGHOST</envar>, si elle est initialisée, sinon une connexion
	socket de domaine Unix est tentée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-l <replaceable>dbname</replaceable></option></term>
      <term><option>--database=<replaceable>dbname</replaceable></option></term>
      <listitem>
       <para>
         Spécifie le nom de la base où se connecter pour la sauvegarde des
	 gobjets globaux et pour découvrir les bases qui devraient être
	 sauvegardées. Si cette option n'est pas utilisée, la base
	 <quote>postgres</quote> est utilisé et, si elle n'est pas,
         <quote>template1</quote> sera utilisée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-p <replaceable>port</replaceable></option></term>
      <term><option>--port=<replaceable>port</replaceable></option></term>
      <listitem>
       <para>
	Précise le port TCP ou l'extension du fichier socket de domaine Unix
	local sur lequel le serveur est en écoute des connexions. La valeur par défaut
	est la variable d'environnement <envar>PGPORT</envar>, si elle est
	initialisée, ou la valeur utilisée lors de la compilation.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-U <replaceable>nomutilisateur</replaceable></option></term>
      <term><option>--username=<replaceable>nomutilisateur</replaceable></option></term>
      <listitem>
       <para>
        Utilisateur utilisé pour initier la connexion.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-w</></term>
      <term><option>--no-password</></term>
      <listitem>
       <para>
        Never issue a password prompt.  If the server requires
        password authentication and a password is not available by
        other means such as a <filename>.pgpass</filename> file, the
        connection attempt will fail.  This option can be useful in
        batch jobs and scripts where no user is present to enter a
        password.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-W</option></term>
      <term><option>--password</option></term>
      <listitem>
       <para>
        Force <application>pg_dumpall</application> à demander un mot de passe
	avant la connexion à une base de données.
       </para>

       <para>
        Cette option n'est jamais obligatoire car
        <application>pg_dumpall</application> demandera automatiquement un
	mot de passe si le serveur exige une authentification par mot de
	passe. Néanmoins, <application>pg_dumpall</application> perdra une
	tentative de connexion pour trouver que le serveur veut un mot de
	passe. Dans certains cas, il est préférable d'ajouter l'option
        <option>-W</option> pour éviter la tentative de connexion.
       </para>

       <para>
        Notez que le mot de passe sera demandé pour chaque base de données
	à sauvegarder. Habituellement, il est préférable de configurer un
	fichier <filename>~/.pgpass</filename> pour que de s'en tenir à une
	saisie manuelle du mot de passe.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--role=<replaceable class="parameter">rolename</replaceable></option></term>
      <listitem>
       <para>
        Specifies a role name to be used to create the dump.
        This option causes <application>pg_dumpall</> to issue a
        <command>SET ROLE</> <replaceable class="parameter">rolename</>
        command after connecting to the database. It is useful when the
        authenticated user (specified by <option>-U</>) lacks privileges
        needed by <application>pg_dumpall</>, but can switch to a role with
        the required rights.  Some installations have a policy against
        logging in directly as a superuser, and use of this option allows
        dumps to be made without violating the policy.
       </para>
      </listitem>
     </varlistentry>
   </variablelist>
  </para>
 </refsect1>


 <refsect1>
  <title>Environnement</title>

  <variablelist>
   <varlistentry>
    <term><envar>PGHOST</envar></term>
    <term><envar>PGOPTIONS</envar></term>
    <term><envar>PGPORT</envar></term>
    <term><envar>PGUSER</envar></term>

    <listitem>
     <para>
      Paramètres de connexion par défaut
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Cet outil, comme la plupart des autres outils <productname>PostgreSQL</productname>,
   utilise aussi les variables d'environnement supportées par la bibliothèque
   <application>libpq</application> (voir <xref linkend="libpq-envars"/>).
  </para>

 </refsect1>


 <refsect1>
  <title>Notes</title>

  <para>
   Comme <application>pg_dumpall</application> appelle
   <application>pg_dump</application> en interne, certains messages de
   diagnostique se réfèrent en fait à <application>pg_dump</application>.
  </para>

  <para>
   Une fois la restauration effectuée, il est conseillé de lancer 
   <command>ANALYZE</command> sur chaque
   base de données, de façon à ce que l'optimiseur dispose de statistiques
   utiles. <command>vacuumdb -a -z</command> peut également être utilisé pour analyser
   toutes les bases de données.
  </para>

  <para>
   <application>pg_dumpall</application> requiert que tous les tablespaces
   nécessaires existent avant la restauration. Dans le cas contraire, la
   création de la base échouera pour une base qui ne se trouve pas dans
   l'emplacement par défaut.
  </para>

</refsect1>


 <refsect1 id="app-pg-dumpall-ex">
  <title>Exemples</title>
  <para>
   Sauvegarder toutes les bases de données&nbsp;:

<screen><prompt>$</prompt> <userinput>pg_dumpall &gt; db.out</userinput>
</screen>
  </para>

  <para>
   Recharger cette base de données&nbsp;:
<screen><prompt>$</prompt> <userinput>psql -f db.out postgres</userinput>
</screen>
   (La base de données utilisée pour la connexion initiale n'a pas d'importance ici
   car le fichier de script créé par <application>pg_dumpall</application>
   contient les commandes nécessaires à la création et à la connexion aux bases
   de données sauvegardées.)
  </para>
 </refsect1>

 <refsect1>
  <title>Voir aussi</title>

  <para>
    Vérifier <xref linkend="app-pgdump"/> pour des détails sur les conditions
    d'erreur possibles.
  </para>
 </refsect1>   

</refentry>
