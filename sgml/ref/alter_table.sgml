<!--
$Header: /var/lib/cvs/pgsql-fr/sgml/ref/alter_table.sgml,v 1.6.2.2 2005/07/03 21:48:01 guillaume Exp $
PostgreSQL documentation
-->

<refentry id="SQL-ALTERTABLE">
 <refmeta>
  <refentrytitle id="sql-altertable-title">ALTER TABLE</refentrytitle>
  <refmiscinfo>SQL - Commandes du langage</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>ALTER TABLE</refname>
  <refpurpose>change la définition d'une table</refpurpose>
 </refnamediv>

 <indexterm zone="sql-altertable">
  <primary>ALTER TABLE</primary>
 </indexterm>

 <refsynopsisdiv>
<synopsis>
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    ADD [ COLUMN ] <replaceable class="PARAMETER">colonne</replaceable> <replaceable class="PARAMETER">type</replaceable> [ <replaceable class="PARAMETER">contraintedecolonne</replaceable> [ ... ] ]
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    DROP [ COLUMN ] <replaceable class="PARAMETER">colonne</replaceable> [ RESTRICT | CASCADE ]
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    ALTER [ COLUMN ] <replaceable class="PARAMETER">colonne</replaceable> { SET DEFAULT <replaceable class="PARAMETER">expression</replaceable> | DROP DEFAULT }
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    ALTER [ COLUMN ] <replaceable class="PARAMETER">colonne</replaceable> { SET | DROP } NOT NULL
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    ALTER [ COLUMN ] <replaceable class="PARAMETER">colonne</replaceable> SET STATISTICS <replaceable class="PARAMETER">entier</replaceable>
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    ALTER [ COLUMN ] <replaceable class="PARAMETER">colonne</replaceable> SET STORAGE { PLAIN | EXTERNAL | EXTENDED | MAIN }
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    SET WITHOUT OIDS
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    RENAME [ COLUMN ] <replaceable class="PARAMETER">colonne</replaceable> TO <replaceable
    class="PARAMETER">nouvellecolonne</replaceable>
ALTER TABLE <replaceable class="PARAMETER">nom</replaceable>
    RENAME TO <replaceable class="PARAMETER">nouveaunom</replaceable>
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    ADD <replaceable class="PARAMETER">contraintedetable</replaceable>
ALTER TABLE [ ONLY ] <replaceable class="PARAMETER">nom</replaceable> [ * ]
    DROP CONSTRAINT <replaceable class="PARAMETER">nomdecontrainte</replaceable> [ RESTRICT | CASCADE ]
ALTER TABLE <replaceable class="PARAMETER">nom</replaceable>
    OWNER TO <replaceable class="PARAMETER">nouveauproprietaire</replaceable>
ALTER TABLE <replaceable class="PARAMETER">nom</replaceable>
    CLUSTER ON <replaceable class="PARAMETER">nomindex</replaceable>
</synopsis>
 </refsynopsisdiv>

 <refsect1>
  <title>Description</title>

  <para>
   <command>ALTER TABLE</command> change la définition d'une table existante.
   Il existe plusieurs variantes&nbsp;:

  <variablelist>
   <varlistentry>
    <term><literal>ADD COLUMN</literal></term>
    <listitem>
     <para>
      Cette variante ajoute une nouvelle colonne à la table en utilisant la même syntaxe que
       <xref linkend="SQL-CREATETABLE" endterm="SQL-CREATETABLE-TITLE">.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>DROP COLUMN</literal></term>
    <listitem>
     <para>
      Cette variante supprime une colonne d'une table. Les index et les 
      contraintes de table référençant cette colonne sont automatiquement supprimés.
      Il faut utiliser l'option <literal>CASCADE</> si certains objets hors
      de la table dépendent de cette colonne, comme par exemple des références
      de clés étrangères ou des vues.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>SET</literal>/<literal>DROP DEFAULT</literal></term>
    <listitem>
     <para>
      Ces variantes ajoutent ou enlèvent des valeurs par défaut pour une colonne.
      Ces valeurs par défaut ne s'appliquent qu'aux prochaines commandes
      <command>INSERT</command>. Elles ne modifient pas les lignes déjà 
      présentes dans la table. Des valeurs par défaut peuvent aussi être créées
      pour les vues. Dans ce cas, elles sont ajoutées aux commandes 
      <command>INSERT</> de la vue avant que la règle 
      <literal>ON INSERT</literal> de la vue ne soit appliquée.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>SET</literal>/<literal>DROP NOT NULL</literal></term>
    <listitem>
     <para>
      Ces variantes changent le fait que la colonne indique autoriser les
      valeurs NULL ou non. <literal>SET NOT NULL</> ne peut être utilisé que
      si la colonne ne contient pas de valeurs NULL.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>SET STATISTICS</literal></term>
    <listitem>
     <para>
      Cette variante permet de modifier l'objectif de collecte de statistiques
      par colonne pour les opérations d'analyse 
      (<xref linkend="sql-analyze" endterm="sql-analyze-title">) à venir.
      L'objectif prend une valeur entre 0 et 1000. Le mettre à -1 pour utiliser
      l'objectif de statistiques par défaut du système.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>SET STORAGE</literal></term>
    <listitem>
     <para>
      Ces variantes changent le mode de stockage pour une colonne. Cela permet de
      contrôler si cette colonne est gardée en ligne dans la table ou bien
      externalisée dans une table supplémentaire, et si les données doivent
      être compressées ou non. 
      <literal>PLAIN</literal> doit être utilisé pour les valeurs
      de longueur fixe, comme les <type>integer</type> et est en ligne non
      compressé. <literal>MAIN</literal> est pour les données en ligne 
      compressibles. <literal>EXTERNAL</literal> est pour les données externes
      non compressées. <literal>EXTENDED</literal> est pour les données externes 
      compressées. <literal>EXTENDED</literal> est la valeur par défaut pour tous
      les types qui le supportent. L'utilisation d'<literal>EXTERNAL</literal>,
      par exemple, rendra les opérations d'extraction de sous chaînes plus 
      rapides mais utilisera plus d'espace de stockage.
      
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>SET WITHOUT OIDS</literal></term>
    <listitem>
     <para>
      Cette forme supprime la colonne <literal>oid</literal> de la table.
      La suppression des OID d'une table n'intervient pas immédiatement.
      L'espace occupé par l'OID est récupéré lorsque la ligne est mise à jour.
      Si la ligne n'est pas mise à jour, l'espace utilisé par l'OID et sa
      valeur est gardé indéfiniment.
      Cette commande est sémantiquement similaire au processus de suppression
      de colonne avec <literal>DROP COLUMN</literal>.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>RENAME</literal></term>
    <listitem>
     <para>
      La variante <literal>RENAME</literal> change le nom d'une table 
      (ou d'un index, d'une séquence, d'une vue) ou le nom d'une colonne
      de la table. Elle est sans effet sur les données stockées.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>ADD <replaceable class="PARAMETER">contraintedetable</replaceable></literal></term>
    <listitem>
     <para>
      Cette variante ajoute une nouvelle contrainte à une table en utilisant la 
      même syntaxe que 
      <xref linkend="SQL-CREATETABLE" endterm="SQL-CREATETABLE-TITLE">.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>DROP CONSTRAINT</literal></term>
    <listitem>
     <para>
      Cette variante supprime des contraintes d'une table. 
      Actuellement,
      les contraintes n'ont pas nécessairement un nom unique, si bien qu'il
      peut y avoir plusieurs contraintes qui ont le nom donné en paramètre.
      Toutes ces contraintes sont supprimées.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>OWNER</literal></term>
    <listitem>
     <para>
      Cette variante change le propriétaire d'une table, d'un index, d'une
      séquence, ou d'une vue. Le nouveau propriétaire est celui passé 
      en paramètre.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><literal>CLUSTER</literal></term>
    <listitem>
     <para>
      Cette variante marque la table pour une future opération de 
      réorganisation en cluster 
      (<xref linkend="SQL-CLUSTER" endterm="sql-cluster-title">).
     </para>
    </listitem>
   </varlistentry>

  </variablelist>
  </para>

  <para>
   Il faut être propriétaire de la table pour utiliser <command>ALTER TABLE</>,
   sauf pour <command>ALTER TABLE OWNER</>, qui ne peut être utilisée que par 
   un super utilisateur.
  </para>
 </refsect1>

 <refsect1>
  <title>Paramètres</title>

    <variablelist>

     <varlistentry>
      <term><replaceable class="PARAMETER">nom</replaceable></term>
      <listitem>
       <para>
    Le nom (éventuellement précisé par un schéma) d'une table existante,
    que l'on veut modifier. Si <literal>ONLY</> est indiqué, cette table
    seulement est modifiée. Si <literal>ONLY</> est absent, alors la table
    et toutes ses tables filles (s'il y en a) sont modifiées.
    <literal>*</> peut être ajouté au nom de la table pour indiquer que ses
    tables descendantes doivent être modifiées. Dans la version courante,
    c'est le comportement par défaut. Dans les versions antérieures à la
    7.1, <literal>ONLY</> était le comportement par défaut.
    Le comportement par défaut peut être modifié en changeant le paramètre
    de configuration <varname>sql_inheritance</varname>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><replaceable class="PARAMETER">colonne</replaceable></term>
      <listitem>
       <para>
    Nom d'une colonne existante ou nouvelle.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><replaceable class="PARAMETER">type</replaceable></term>
      <listitem>
       <para>
    Type de données de la nouvelle colonne.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><replaceable class="PARAMETER">nouvellecolonne</replaceable></term>
      <listitem>
       <para>
    Nouveau nom d'une colonne existante.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><replaceable class="PARAMETER">nouveaunom</replaceable></term>
      <listitem>
       <para>
    Nouveau nom de la table.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><replaceable class="PARAMETER">contraintedetable</replaceable></term>
      <listitem>
       <para>
    Nouvelle contrainte de table pour la table.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><replaceable class="PARAMETER">nomdecontrainte</replaceable></term>
      <listitem>
       <para>
    Nom d'une contrainte existante à supprimer
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><replaceable class="PARAMETER">nouveauproprietaire</replaceable></term>
      <listitem>
       <para>
    Nom d'utilisateur du nouveau propriétaire de la table.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><replaceable class="PARAMETER">nomindex</replaceable></term>
      <listitem>
       <para>
    Nom de l'index sur lequel la table doit être réorganisée en cluster.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><literal>CASCADE</literal></term>
      <listitem>
       <para>
        Supprime automatiquement les objets qui dépendent de la colonne 
        ou de la contrainte supprimée (par exemple, les vues référençant 
        cette colonne).
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><literal>RESTRICT</literal></term>
      <listitem>
       <para>
        Refuse de supprimer la colonne ou la contrainte s'il y a des
        objets dépendants. C'est le comportement par défaut.
       </para>
      </listitem>
     </varlistentry>

    </variablelist>
 </refsect1>

 <refsect1>
  <title>Notes</title>

   <para>
    Le mot clé <literal>COLUMN</literal> n'est pas nécessaire. Il peut
    être omis.
   </para>

   <para>
    La version actuelle de <literal>ADD COLUMN</literal> ne permet pas 
    d'utiliser les clauses de valeur par défaut ni de contrainte 
    <literal>NOT NULL</>.
    La nouvelle colonne a toujours toutes ses valeurs NULL.
    Il faut utiliser la forme <literal>SET DEFAULT</literal> de
    <command>ALTER TABLE</command> pour modifier ensuite la valeur par défaut.
    (Vous voudrez peut-être aussi mettre à jour les lignes existantes de la 
    table avec la nouvelle valeur par défaut en utilisant 
    <xref linkend="sql-update" endterm="sql-update-title">.)
    Si vous voulez indiquer qu'une colonne n'est jamais nulle, utilisez la
    variante <literal>SET NOT NULL</> après avoir entré des valeurs non NULL
    pour cette colonne pour toutes les lignes de la table.
   </para>

   <para>
    La forme <literal>DROP COLUMN</literal> ne supprime pas physiquement la 
    colonne, mais la rend simplement invisible au SQL.
    Par la suite, les ordres d'insertion et de mise à jour sur cette table 
    stockeront une valeur NULL pour la colonne.
    Du coup, supprimer une colonne ne réduit pas immédiatement la taille de la
    table sur le disque car l'espace occupé par la colonne n'est pas 
    récupéré. Cet espace sera récupéré petit à petit, au fur et à mesure des 
    mises à jour des lignes de la table.
    Pour récupérer immédiatement l'espace, il faut faire un faux
    <command>UPDATE</> sur toutes les lignes de la table, puis la réorganiser 
    avec un vacuum, comme ce qui suit&nbsp;:
<programlisting>
UPDATE table SET col = col;
VACUUM FULL table;
</programlisting>
   </para>
    
   <para>
    Si une table a des tables descendantes, il n'est pas possible d'ajouter
    ou renommer une colonne dans la table parent sans le faire aussi pour
    ses descendantes. Donc, la commande <command>ALTER TABLE ONLY</command>
    est rejetée. Ceci assure que les descendantes ont toujours des colonnes
    correspondant à celles de la table parente.

   </para>

   <para>
    Un appel récursif à <literal>DROP COLUMN</literal> supprimera une colonne
    d'une table descendante si et seulement si la table descendante n'hérite 
    pas de cette colonne d'une autre table et n'a jamais eu de définition 
    indépendante de la colonne.
    Une suppression de colonne non récursive (c'est à dire une commande
    <command>ALTER TABLE ONLY ... DROP COLUMN</command>) ne supprime
    jamais les colonnes descendantes mais les marque comme définies 
    de manière indépendante, plutôt qu'héritées.
   </para>

   <para>
    On ne peut pas changer quoi que ce soit dans une table du catalogue
    système.
   </para>

   <para>
    Voir la commande <command>CREATE TABLE</command> pour avoir une 
    description plus complète des paramètres valides.
    <xref linkend="ddl"> donne plus d'informations sur l'héritage.
   </para>
 </refsect1>

 <refsect1>
  <title>Exemples</title>

  <para>
   Pour ajouter une colonne de type <type>varchar</type> à une table&nbsp;:
<programlisting>
ALTER TABLE distributeurs ADD COLUMN adresse varchar(30);
</programlisting>
  </para>

  <para>
   Pour supprimer une colonne d'une table&nbsp;:
<programlisting>
ALTER TABLE distributeurs DROP COLUMN adresse RESTRICT;
</programlisting>
  </para>

  <para>
   Pour renommer une colonne existante&nbsp;:
<programlisting>
ALTER TABLE distributeurs RENAME COLUMN adresse TO city;
</programlisting>
  </para>

  <para>
   Pour renommer une table existante&nbsp;:
<programlisting>
ALTER TABLE distributeurs RENAME TO suppliers;
</programlisting>
  </para>

  <para>
   Pour ajouter une contrainte NOT NULL à une colonne&nbsp;:
<programlisting>
ALTER TABLE distributeurs ALTER COLUMN rue SET NOT NULL;
</programlisting>
   Pour supprimer une contrainte NOT NULL d'une colonne&nbsp;:
<programlisting>
ALTER TABLE distributeurs ALTER COLUMN rue DROP NOT NULL;
</programlisting>
  </para>

  <para> 
   Pour ajouter une contrainte de vérification sur une table&nbsp;:
<programlisting>
ALTER TABLE distributeurs ADD CONSTRAINT verif_zip CHECK (char_length(zipcode) =
5);
</programlisting>
  </para>

  <para> 
   Pour supprimer une contrainte de vérification d'une table et de toutes ses
   tables filles&nbsp;:
<programlisting>
ALTER TABLE distributeurs DROP CONSTRAINT verif_zip;
</programlisting>
  </para>

  <para> 
   Pour ajouter une contrainte de clé étrangère à une table&nbsp;:
<programlisting>
ALTER TABLE distributeurs ADD CONSTRAINT distfk FOREIGN KEY (adresse) REFERENCES
adresses (adresse) MATCH FULL;
</programlisting>
  </para>

  <para> 
   Pour ajouter une contrainte unique (multicolonnes) à une table&nbsp;:
<programlisting>
ALTER TABLE distributeurs ADD CONSTRAINT dist_id_zipcode_key UNIQUE (dist_id,
zipcode);
</programlisting>
  </para>

  <para> 
   Pour ajouter une clé primaire nommée automatiquement à une table.
   Remarque&nbsp;: une table ne peut avoir qu'une seule clé primaire dans toute 
   sa vie.
<programlisting>
ALTER TABLE distributeurs ADD PRIMARY KEY (dist_id);
</programlisting>
  </para>
 </refsect1>

 <refsect1>
  <title>Compatibilité</title>

  <para>
   La variante <literal>ADD COLUMN</literal> est conforme au standard SQL,
   à l'exception du fait qu'elle ne supporte pas les contraintes par défaut 
   et NOT NULL, comme expliqué précédemment.
   La variante <literal>ALTER COLUMN</literal> est complètement compatible.
  </para>

  <para>
   Les clauses pour renommer des tables, des colonnes, des indexes, des vues et
   des séquences sont des extensions du standard SQL.
  </para>

  <para>
   <command>ALTER TABLE DROP COLUMN</> peut être utilisé pour supprimer
   la seule colonne d'une table, laissant une table sans colonne.
   C'est une extension de SQL, qui ne permet pas les tables sans colonne.
  </para>
 </refsect1>
</refentry>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:nil
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
sgml-parent-document:nil
sgml-default-dtd-file:"../reference.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:"/usr/lib/sgml/catalog"
sgml-local-ecat-files:nil
End:
-->

